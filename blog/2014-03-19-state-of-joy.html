
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>State of Joy - Language Perils</title>
  <meta name="author" content="Daniel Beskin">

  
  <meta name="description" content="Having finished with binary trees and getting somewhat sidetracked by metaprogramming, we are now ready for our next small project. Implementing &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html">
  <link href="/language_perils/favicon.png" rel="icon">
  <link href="/language_perils/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/language_perils/javascripts/modernizr.js"></script>
  <script src="/language_perils/javascripts/ender.js"></script>
  <script src="/language_perils/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/language_perils/atom.xml" rel="alternate" title="Language Perils" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39780832-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/language_perils/atom.xml" rel="subscribe-rss" title="subscribe via RSS"></a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ncreep.github.io/language_perils" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/language_perils/">
        <span class="site_title">
            Language Perils
        </span>
       
    </a></li>
  <li><a href="/language_perils/">Blog</a></li>
  <li><a href="/language_perils/blog/archives">Archives</a></li>
  <!-- <li><a href="/language_perils/about">About me</a></li> -->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">State of Joy</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-19T01:54:19+02:00" pubdate data-updated="true">Mar 19<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Having finished with <a href="/language_perils/blog/2013-04-21-joyous-tree-friends.html">binary trees</a> and getting somewhat sidetracked by <a href="/language_perils/blog/2013-05-24-meta-joy.html">metaprogramming</a>, we are now ready for our next small project. Implementing binary trees was sort of a warm-up for getting used to Joy &ndash; now I would like to do something a bit less textbooky.</p>

<p>As you may recall, Joy has a very flexible syntax due to its homoiconicity (as can be seen in the metaprogramming post). Having a flexible syntax should make a language easily amenable to embedding of <a href="http://en.wikipedia.org/wiki/Domain-specific_language">domain-specific languages</a> (DSLs). Personally, I&rsquo;m a big fan of DSLs, so trying to implement one in Joy seems like a nice idea for a small project.</p>

<p>In order to actually have a domain-specific language, we first need to come up with a domain. Having gone through a careful process of examining and comparing various domains (i.e., choosing the first thing that randomly came up in my mind at some distant point in time), I decided to model <a href="http://en.wikipedia.org/wiki/State_machine">state machines</a>. More specifically, I&rsquo;ll be implementing a small language that can describe state machines augmented by a stack, which makes it a <a href="http://en.wikipedia.org/wiki/Pushdown_automaton">pushdown automaton</a>. Adding a stack to our machine seems like a natural idea for a stack-based language and also makes the domain a tad more interesting; we&rsquo;ll see how that works out later on.</p>

<!-- more -->


<p>(For the more pedantically inclined, what we&rsquo;ll implement will actually have access to the whole stack and to the whole of Joy&rsquo;s stack-manipulation power, so strictly speaking it&rsquo;s going to be something more powerful than a pushdown automaton, but we won&rsquo;t linger on that point.)</p>

<p>Before we get to our state machine DSL, we&rsquo;ll write some code that can evaluate state machines, which will give us a better understanding of our domain; let us get to that.</p>

<p>A state machine is simply a list of states with their corresponding transition functions. The transition functions take the current input and, depending on its value and the current stack, decide what the next state is. In our implementation, a state will be a list pair, where the first item is the value of the state, e.g., its name, and the second is the state transition function. To make this more obvious in the code, we&rsquo;ll define their corresponding accessors:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>state-value == 0 at # fetch the state value
</span><span class='line'>next-state == 1 at # fetch the transition function</span></code></pre></td></tr></table></div></figure>


<p>(All code for this post can be found in <a href="https://github.com/ncreep/language_perils/tree/master/Joy/state_machine">this folder</a>, the main code for the state machine implementation is in <a href="https://github.com/ncreep/language_perils/blob/master/Joy/state_machine/state_machine.joy">state_machine.joy</a>)</p>

<p>The core part of our state machine evaluation process is this function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># runs a state against an input list: input state stack -&gt; final-state-value
</span><span class='line'>run-state-from-stack == 
</span><span class='line'>  swap # arguments are now: input stack state
</span><span class='line'>  [finish-state-run] [popd popd state-value] [
</span><span class='line'>    [move-first] dip
</span><span class='line'>    next-state i # input [stack value] -&gt; input new-stack new-state
</span><span class='line'>  ] tailrec;</span></code></pre></td></tr></table></div></figure>


<p>It takes a list of inputs, an initial state, and a stack (which is just a list that we&rsquo;ll treat as a stack). It then runs the state machine against the inputs while maintaining the stack in the background. The whole thing works by recursively evaluating the current transition function against the current input and stack; the recursion is made anonymous by using the <code>tailrec</code> combinator. Let&rsquo;s break down the definition:</p>

<ul>
<li>We swap the arguments to have them in the right order for our recursive step.</li>
<li>We check whether we are done (i.e., there&rsquo;s no more input) with the <code>finish-state-run</code> function.</li>
<li>If so, we throw out all our arguments and pick out the current state value.</li>
<li>Otherwise, we pair up our current input (the first item in the input list) and the current stack using the <code>move-first</code> function.</li>
<li>Using the <code>i</code> combinator, we evaluate the transition function against the input/stack pair.</li>
<li>The output of the transition function is the next state; at this point we recurse and start all over.</li>
</ul>


<p>And that&rsquo;s all we need to evaluate a state machine. To see that it actually works, let&rsquo;s code up a concrete state machine. Apart from actually demonstrating what we&rsquo;ve done thus far, this will also be helpful in the design of our DSL. It may so happen that what we already have is close enough to our domain, and we won&rsquo;t have a need for a special language. That being very unlikely, at the very least we may get some pointers to what aspects of our syntax we should optimize to get closer to the domain.</p>

<p><em>(cue the narrator)</em></p>

<blockquote><p>Family is important, and as programmers, we should strive to help other programmers deal with realistic scenarios that come up in family life. In this installment of our &ldquo;Family for Geeks&rdquo;, we&rsquo;ll see how to deal with babies.</p></blockquote>

<p><em>(fading out with happy jingle music)</em></p>

<p>So, we&rsquo;ll implement a state machine that totally realistically models the behavior of a typical baby. Our baby has a number of possible states: sleepy, hungry, asleep, and crying. Obviously, the last one is the most common. Our main goal is to choose the right action to get the baby to fall asleep. We have a number of actions that we can do with the baby; these are the inputs to the state machine: sing a lullaby, feed, and soothe. To make this more realistic, our baby is going to <del>be vindictive</del> have a memory. The baby is going to keep count for every time we mess up and choose a wrong action. Once we&rsquo;ve messed up too many times, the baby is going to call a social worker. Calling a social worker will be counted as yet another state of a baby. Here is our baby&rsquo;s behavior described by a table:</p>

<pre id="baby-table">
             || sleepy | hungry | asleep |          crying            | call social worker |
============================================================================================
sing lullaby || asleep | crying | crying | should call social worker? | call social worker |
        feed || crying | asleep | crying | should call social worker? | call social worker |
      soothe || crying | crying | crying |          asleep            | call social worker |
</pre>


<p>The header row contains the possible states of the baby; the first column has the possible actions. For every state/action pair, we choose the baby&rsquo;s next state. Getting the baby into the crying state is considered wrong, and we&rsquo;ll use the stack to keep track of the number of wrongs. If we get the baby into the asleep state, we get to decrement our wrongs count. Once the baby is in the crying state, we check whether the baby was wronged too many times (&ldquo;should call social worker?&rdquo;). If so, we move to the call social worker state (which is pretty much game over in this state machine). Otherwise, we keep on crying.</p>

<p>This sums up the behavior of a typical baby in a completely life-like fashion. Now, we can try and write it down as real code (which can be found in <a href="https://github.com/ncreep/language_perils/blob/master/Joy/state_machine/baby_state_machine.joy">baby_state_machine.joy</a>):</p>

<div id="baby-states">
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sleepy == ["sleepy" [[
</span><span class='line'>  [["sing-lullaby" input-is] right asleep]
</span><span class='line'>  [["feed" input-is] wrong crying]
</span><span class='line'>  [["soothe" input-is] wrong crying]
</span><span class='line'>] condn]];
</span><span class='line'>  
</span><span class='line'>hungry == ["hungry" [[
</span><span class='line'>  [["sing-lullaby" input-is] wrong crying]
</span><span class='line'>  [["feed" input-is] right asleep]
</span><span class='line'>  [["soothe" input-is] wrong crying]
</span><span class='line'>] condn]];
</span><span class='line'>  
</span><span class='line'>asleep == ["asleep" [[
</span><span class='line'>  [["sing-lullaby" input-is] wrong crying]
</span><span class='line'>  [["feed" input-is] wrong crying]
</span><span class='line'>  [["soothe" input-is] wrong crying]
</span><span class='line'>] condn]];
</span><span class='line'>  
</span><span class='line'>crying == ["crying" [[
</span><span class='line'>  [["sing-lullaby" input-is] should-call-social-worker]
</span><span class='line'>  [["feed" input-is] should-call-social-worker]
</span><span class='line'>  [["soothe" input-is] right asleep]
</span><span class='line'>] condn]];
</span><span class='line'>
</span><span class='line'>call-social-worker == ["call-social-worker" [cur-stack call-social-worker]];</span></code></pre></td></tr></table></div></figure>
</div>


<p>Well, that sucked&hellip; If you squint hard enough, you may recognize our state machine from before, but there&rsquo;s a whole lot of noise obscuring it from us.</p>

<p>As you can see, every state gets its own top-level definition. The first bit of the state is just its name as a string. Next comes the state transition function in the form of a conditional <code>condn</code>, which is just like the built-in <code>cond</code> (which acts like a multi-branch <code>if</code> expression) but does not require a default case. Every line corresponds to one possible input. The <code>input-is</code> function checks the current input against the string; if it matches, we execute the following code. Because our input is part of an input/stack pair, the <code>input-is</code> function has to break it down to fetch out the input from the pair and only then compare it to the input in the current branch.</p>

<p>The code that we execute after choosing a branch works against the input/stack pair and must produce a new stack value and a new state as a result. In most cases, we need to decide whether the action is wrong or right and increment/decrement the stack, then we choose the next state. For this purpose, we use one of either <code>wrong</code> or <code>right</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wrong == [succ] on-stack;
</span><span class='line'>right == [pred] on-stack;
</span><span class='line'>
</span><span class='line'># [stack value] func -&gt; new-stack
</span><span class='line'>on-stack  == swap cur-stack uncons [swap i] dip cons;</span></code></pre></td></tr></table></div></figure>


<p>The <code>on-stack</code> combinator takes a piece of code and executes it against the top value of the current stack. It takes care of splitting out the stack from the input/stack pair (using <code>cur-stack</code>) and applying a function to its top value. The <code>wrong</code> and <code>right</code> functions just pass the <code>succ</code> (increment) or <code>pred</code> (decrement) to the <code>on-stack</code> combinator to achieve the required effect.</p>

<p>For example, the line <code>[["feed" input-is] wrong crying]</code> checks whether the input is <code>feed</code>; if so, the action was wrong, and we increment the counter and move on to the <code>crying</code> state.</p>

<p>In the case where we need to check whether a social worker should be called, we invoke <code>should-call-social-worker</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>should-call-social-worker == 
</span><span class='line'>  [cur-stack first max-mistakes &gt;=] 
</span><span class='line'>  [cur-stack call-social-worker] 
</span><span class='line'>  [wrong crying] ifte</span></code></pre></td></tr></table></div></figure>


<p>This checks whether the counter on the top of the stack went past our mistake limit; if so, it leaves the stack as is (<code>cur-stack</code>) and chooses the <code>call-social-worker</code> state. Otherwise, we invoke the <code>wrong</code> function and stay in the <code>crying</code> state.</p>

<p>The <code>call-social-worker</code> state is trivial and just keeps the stack as is, without moving to another state.</p>

<p>We can now spot some patterns of repetitiveness that, hopefully, our DSL will be able to eradicate. Firstly, we are repeating our state names both as their definition name and their string name in the state value. Secondly, the list of possible inputs is repeated in almost all of the states. Lastly, manipulating the stack is rather explicit; every function we want to invoke on the stack has to be wrapped in an <code>on-stack</code> combinator, and even if we don&rsquo;t need anything on the stack at all, we still have to mention it with the <code>cur-stack</code> function. You&rsquo;d expect to be able to achieve something more transparent than that from a stack-based language.</p>

<p>All that aside, we can actually execute our state machine with the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>["soothe"] sleepy run-baby-state # =&gt; "crying"
</span><span class='line'>["soothe" "feed" "sing-lullaby" "feed"] sleepy run-baby-state # =&gt; "call-social-worker"</span></code></pre></td></tr></table></div></figure>


<p>The first argument is the input list, the second is the state we start from.<br/>
So at least it works as expected.</p>

<p>This concludes the exposition of the domain, in the next <a href="/language_perils/blog/2014-03-20-domain-specific-joy.html">installment</a> we&rsquo;ll try to come up with an actual language specific to it.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Daniel Beskin</span></span>

      








  


<time datetime="2014-03-19T01:54:19+02:00" pubdate data-updated="true">Mar 19<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/language_perils/blog/categories/joy/'>Joy</a>, <a class='category' href='/language_perils/blog/categories/concatenative/'>concatenative</a>, <a class='category' href='/language_perils/blog/categories/stack-based/'>stack-based</a>, <a class='category' href='/language_perils/blog/categories/state-machine/'>state machine</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html" data-via="" data-counturl="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/language_perils/blog/2013-05-24-meta-joy.html" title="Previous Post: Meta-Joy">&laquo; Meta-Joy</a>
      
      
        <a class="basic-alignment right" href="/language_perils/blog/2014-03-20-domain-specific-joy.html" title="Next Post: Domain-specific Joy">Domain-specific Joy &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/language_perils/blog/2014-03-24-joy-no-more.html">Joy No More</a>
      </li>
    
      <li class="post">
        <a href="/language_perils/blog/2014-03-20-domain-specific-joy.html">Domain-specific Joy</a>
      </li>
    
      <li class="post">
        <a href="/language_perils/blog/2014-03-19-state-of-joy.html">State of Joy</a>
      </li>
    
      <li class="post">
        <a href="/language_perils/blog/2013-05-24-meta-joy.html">Meta-Joy</a>
      </li>
    
      <li class="post">
        <a href="/language_perils/blog/2013-04-21-joyous-tree-friends.html">Joyous Tree Friends</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Daniel Beskin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'langperils';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html';
        var disqus_url = 'http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
