<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Language Perils]]></title>
  <link href="http://ncreep.github.io/language_perils/feed" rel="self"/>
  <link href="http://ncreep.github.io/language_perils/"/>
  <updated>2015-02-25T04:16:12+02:00</updated>
  <id>http://ncreep.github.io/language_perils/</id>
  <author>
    <name><![CDATA[Daniel Beskin]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Frink's Interval Arithmetic for the Masses]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2015-02-19-frinks-interval-arithmetic-for-the-masses.html"/>
    <updated>2015-02-19T19:25:33+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/frinks-interval-arithmetic-for-the-masses</id>
    <content type="html"><![CDATA[<p>In the <a href="http://ncreep.github.io/language_perils/blog/2015-01-08-hello-frink.html">previous post</a> about Frink, we explored how smoothly Frink handles units of measure. In this post, we will focus on another deeply integrated feature of Frink&rsquo;s: interval arithmetic. On Frink&rsquo;s <a href="https://futureboy.us/frinkdocs/">homepage</a> this feature is described as magical. The aim of this post is to try and make sense of this statement. We will now give a quick rundown of interval arithmetic and then proceed to concrete examples. For a more detailed review of the subject, you can refer to <a href="http://en.wikipedia.org/wiki/Interval_arithmetic">Wikipedia</a>, or for a Frink-specific treatment, to the <a href="https://futureboy.us/frinkdocs/#IntervalArithmetic">interval arithmetic section</a> in Frink&rsquo;s documentation. On with it.</p>

<!-- more -->


<h2>Interval arithmetic 101</h2>

<p>In interval arithmetic, instead of using numbers, we use intervals. Specifically, we say that <code>[3, 5]</code> represents the set of numbers between <code>3</code> and <code>5</code>. Given some intervals, we can define the basic arithmetic operations on them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[a, b] + [c, d] = [a + c, b + d]
</span><span class='line'>[a, b] - [c, d] = [a - d, b - c]
</span><span class='line'>[a, b] * [c, d] = [min(ac, ad, bc, bd), max(ac, ad, bc, bd)]
</span><span class='line'>[a, b] / [c, d] = [min(a/c, a/d, b/c, b/d), max(a/c, a/d, b/c, b/d)]</span></code></pre></td></tr></table></div></figure>


<p>Which should make intuitive sense if you squint hard enough. With (quite) a bit more thought, it is possible to define interval operations for more complicated functions, e.g. trigonometric functions. And that&rsquo;s exactly what Frink does; most of its mathematical functions transparently support (real) intervals, so one can write:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>x = new interval[-1, 4]
</span><span class='line'>y = new interval[6, 9]
</span><span class='line'>
</span><span class='line'>x + y  // =&gt; [5, 13]
</span><span class='line'>x - y  // =&gt; [-10, -2]
</span><span class='line'>x * y  // =&gt; [-9, 36]
</span><span class='line'>x / y  // =&gt; [-1/6 (approx. -0.16666666666666667), 2/3 (approx. 0.66666666666666667)]
</span><span class='line'>
</span><span class='line'>x^2    // =&gt; [0, 16]
</span><span class='line'>sin[x] // =&gt; [-0.8414709848079, 1]</span></code></pre></td></tr></table></div></figure>


<p>(Note that Frink uses square brackets for function application/definition.)</p>

<p>Although the interval definition syntax is a bit verbose and likely to change later on, the usage is indeed transparent. That is, code written for regular values (like the code above) works with intervals without any modification. Also, as can be seen in the <code>x^2</code> and <code>sin</code> examples, applying a function to an interval is not as simple as applying the function to the interval&rsquo;s boundaries, but rather involves an actual analysis of the function&rsquo;s behavior on the given interval.</p>

<p>And that&rsquo;s all we&rsquo;ll need for the purposes of this post. With this rudimentary knowledge of interval arithmetic, we are now ready to try and flesh out the claim that interval arithmetic is magical.</p>

<h2>Interval hat-trick</h2>

<p>Suppose I want to prepare a classic hat-trick: pull a rabbit out of a top hat. For this, I would obviously need both a top hat and a rabbit. The question is, how do I make sure that the hat fits the rabbit? I can&rsquo;t just order any hat, it has to be large enough to contain the rabbit.</p>

<p><img class="right" src="http://ncreep.github.io/language_perils/images/frink/rabbit_measure.png" width="256" height="392"></p>

<p>Since I know literally nothing about rabbits and their sizes, I will use the picture on the right, depicting a fairly typical rabbit, as a reference.</p>

<p>From this picture, we need to extract an estimate of the rabbit&rsquo;s size. Luckily, the rabbit holds, as they usually do, a pocket watch, and using the handy table from <a href="http://www.kenrockwell.com/watches/pocket-watch-sizes.htm">this</a> site we have an estimate of the diameter of a typical pocket watch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pocketWatch = new interval[1.0, 1.9] inch 
</span><span class='line'>// [0.0254, 0.04826] m (length)</span></code></pre></td></tr></table></div></figure>


<p>As you can see, intervals are integrated with units; we could also have written <code>new interval[1.0 inch, 1.9 inch]</code>, but this way is more concise.</p>

<p>Knowing the diameter of a pocket watch, we can draw a little &ldquo;pocket watch scale&rdquo; for the rabbit (on the same picture on the right). We are assuming that both the legs and the ears are foldable, so the measurement excludes this area. Looking at the picture, we can see that the rabbit is about 10.5 watches tall, and about 5 watches wide. Since I don&rsquo;t really know how squishy a real rabbit is, let&rsquo;s give both dimensions a bit of an error margin either way, so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>heightInWatches = new interval[10.5 - 1, 10.5 + 1]
</span><span class='line'>widthInWatches = new interval[5 - 0.5, 5 + 0.5]</span></code></pre></td></tr></table></div></figure>


<p>Combining with the size of a watch we have:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rabbitHeight = heightInWatches pocketWatch
</span><span class='line'>// [0.2413, 0.55499] m (length)
</span><span class='line'>
</span><span class='line'>rabbitWidth = widthInWatches pocketWatch
</span><span class='line'>// [0.1143, 0.26543] m (length)</span></code></pre></td></tr></table></div></figure>


<p>According to <a href="http://en.wikipedia.org/wiki/Rabbit">Wikipedia</a>, a rabbit&rsquo;s weight is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rabbitWeight = new interval[0.4, 2] kg</span></code></pre></td></tr></table></div></figure>


<p>Which means, assuming that a rabbit forms a perfect cylinder, that we can calculate the rabbit&rsquo;s mass density:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rabbitVolume = pi (rabbitWidth / 2)^2 * rabbitHeight
</span><span class='line'>rabbitDensity = rabbitWeight / rabbitVolume
</span><span class='line'>
</span><span class='line'>rabbitDensity -&gt; "water"
</span><span class='line'>// [0.013025216116065158404, 0.8077748579515481546] water</span></code></pre></td></tr></table></div></figure>


<p>So rabbits float on water; definitely a useful thing to know next time you go out with your rabbit to the beach. (Also, by nothing but a total coincidence, the height that we estimated fits pretty well with the data given in Wikipedia.)</p>

<p>Under the same cylindrical rabbit assumption, the width of the rabbit can be taken as the width of the top hat we&rsquo;ll be using. From which we gather that a magician&rsquo;s head circumference should be:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>magicianHead = pi rabbitWidth
</span><span class='line'>
</span><span class='line'>magicianHead -&gt; "cm"
</span><span class='line'>// [35.90840403053133671, 83.387293804233881917] cm</span></code></pre></td></tr></table></div></figure>


<p>Which according to the table <a href="http://www.ubs.iastate.edu/hat_sizing_chart.html">here</a> makes the potential magician either a giant or an extraordinarily small infant.</p>

<p>Having done this exhaustive research, we are now ready to order a hat. Just need to figure out where one buys a top hat these days&hellip;</p>

<p>Okay, so what do we have here? Essentially, we just did a calculation with built-in error propagation; which in itself is quite nice (and probably useful), but as every poor-soul-of-an-undergraduate-physics-student-stuck-in-a-lab knows, error analysis is not that difficult, even without the support of special programming tools (although I&rsquo;m sure that said student would show nothing but great appreciation for such a tool). So apart from the magical theme, we are yet to achieve any real magic here.</p>

<p>But we won&rsquo;t be giving up just yet.</p>

<h2>Interval plotting</h2>

<p>One good use of interval arithmetic techniques is for plotting. An illustration of this can be found on a <a href="http://futureboy.us/fsp/simplegraph.fsp">demonstration page</a>, which generates ASCII plots for equations. As can be seen in the Frink <a href="http://futureboy.us/fsp/highlight.fsp?f=simplegraph.fsp">source</a> for this page, the code that achieves this uses interval arithmetic and is quite compact.</p>

<p>Let&rsquo;s try to figure out how it works. Before we do that, we need something to compare to the interval arithmetic approach. Since Frink doesn&rsquo;t (yet) have any built-in plotting facilities, we will roll our own simplistic plotting solution. For this purpose, we can leverage Frink&rsquo;s graphics support (which is much more interesting than what I&rsquo;ll be showing here, see the <a href="https://futureboy.us/frinkdocs/#Graphics">documentation</a> for the full story).</p>

<p>Without further ado, the naive plotting solution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>naivePlot[lhs, rhs, xMin, xMax, yMin, yMax, xSteps, ySteps] :=
</span><span class='line'>{
</span><span class='line'>  g = new graphics
</span><span class='line'>  g.drawRectSides[xMin, -yMin, xMax, -yMax] // a frame for the plot
</span><span class='line'>  
</span><span class='line'>  xStep = (xMax - xMin) / xSteps
</span><span class='line'>  yStep = (yMax - yMin) / ySteps
</span><span class='line'>  
</span><span class='line'>  tolerance = 0.05
</span><span class='line'>
</span><span class='line'>  multifor [x, y] = [xMin to xMax step xStep, yMin to yMax step yStep]
</span><span class='line'>  {
</span><span class='line'>      res = abs[lhs[x, y] - rhs[x, y]]
</span><span class='line'>      if res &lt; tolerance
</span><span class='line'>        g.fillRectSize[x, -y, xStep, -yStep]
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  g.show[]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>(the full source code for this and further snippets can be found in the <a href="https://github.com/ncreep/language_perils/tree/master/Frink/interval_arithmetic">repository</a>)</p>

<p>The code should be fairly readable even without much familiarity with Frink. We are defining a function (as denoted by <code>:=</code>). The function takes two function arguments, <code>lhs</code> and <code>rhs</code>, each representing a side of the equation we are about to plot, and a bunch of numbers for the <code>x</code>/<code>y</code> limits and steps. Note that the curly braces must be on a separate line; which, from my point of view, is the only truly evil feature of Frink I&rsquo;ve seen so far.</p>

<p>On line 3, we are initializing a new graphics object; this is the container for our plot. As a first step, on line 4, we are drawing a frame for the plot (otherwise, Frink might clip empty regions around it). Relative to standard mathematical plotting, the graphics object&rsquo;s <code>y</code> axis is inverted, hence the minus signs on all <code>y</code> values.</p>

<p>Next, we need to step through the range of the plot; instead of using two nested loops, we are using a <code>multifor</code>, which combines multiple nested loops into a single construct. At every step, we are applying the <code>lhs</code> and <code>rhs</code> functions to the current <code>x</code>/<code>y</code> values and see whether they are close enough. If they are within the tolerance value, on line 15 we are drawing a filled rectangle to mark that position.</p>

<p>After exiting the loop, on line 18, we invoke the <code>show</code> method on the graphics object, which shows the result on the screen.</p>

<p>This is probably the crappiest plotting solution one could possibly write. The tolerance is abysmal, but since we are using a constant step, a smaller tolerance would take too many steps to achieve anything. As it is, even moderately spiky functions should throw the whole thing off. Nonetheless, this can actually plot something, and it&rsquo;s good enough for illustration purposes.</p>

<p>Let&rsquo;s put it to the test. The preloaded example on the <a href="http://futureboy.us/fsp/simplegraph.fsp">demonstration page</a> plots the equation</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>x^2 + y^2 = 81 sin[x]^2</span></code></pre></td></tr></table></div></figure>


<p>Which should result in a bunch of circles. Let&rsquo;s try to apply <code>naivePlot</code> to draw them. First, we&rsquo;ll define a pair of anonymous functions for the parts of the equation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lhs = { |x, y| x^2 + y^2 }
</span><span class='line'>rhs = { |x, y| 81 sin[x]^2 }</span></code></pre></td></tr></table></div></figure>


<p>The <code>{ |x, y| ... }</code> syntax defines an anonymous function with two arguments. After setting the bounds and number of steps, we can create the plot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xMin = -10
</span><span class='line'>xMax = 10
</span><span class='line'>
</span><span class='line'>yMin = -10
</span><span class='line'>yMax = 10
</span><span class='line'>
</span><span class='line'>xSteps = 300
</span><span class='line'>ySteps = 300
</span><span class='line'>
</span><span class='line'>naivePlot[lhs, rhs, xMin, xMax, yMin, yMax, xSteps, ySteps]</span></code></pre></td></tr></table></div></figure>


<p>And the result:
<img class="center" src="http://ncreep.github.io/language_perils/images/frink/naive_e1_300.png"></p>

<p>Which is reminiscent of the circles pattern we should be getting, but not quite there. We can push up the number of steps:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>naivePlot[lhs, rhs, xMin, xMax, yMin, yMax, 800, 800]</span></code></pre></td></tr></table></div></figure>


<p>To obtain:
<img class="center" src="http://ncreep.github.io/language_perils/images/frink/naive_e1_800.png"></p>

<p>Since the step size is getting smaller, the points we are drawing are tiny. But the circles are definitely visible.</p>

<p>Now we can proceed to the interval arithmetic variant. Here&rsquo;s the code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>intervalPlot[lhs, rhs, xMin, xMax, yMin, yMax, xSteps, ySteps] :=
</span><span class='line'>{
</span><span class='line'>  g = new graphics
</span><span class='line'>  g.drawRectSides[xMin, -yMin, xMax, -yMax] // a frame for the plot
</span><span class='line'>  
</span><span class='line'>  xStep = (xMax - xMin) / xSteps
</span><span class='line'>  yStep = (yMax - yMin) / ySteps
</span><span class='line'>
</span><span class='line'>  multifor [xx, yy] = [xMin to xMax step xStep, yMin to yMax step yStep]
</span><span class='line'>  {
</span><span class='line'>      x = new interval[xx, xx + xStep]
</span><span class='line'>      y = new interval[yy, yy + yStep]
</span><span class='line'>      
</span><span class='line'>      if lhs[x, y] PEQ rhs[x, y] // doing interval comparison
</span><span class='line'>        g.fillRectSize[xx, -yy, xStep, -yStep]
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  g.show[]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The structure of <code>intervalPlot</code> is quite similar to <code>naivePlot</code>. The key difference is that instead of applying <code>lhs</code> and <code>rhs</code> to numbers, we are applying them to intervals. Specifically, at each iteration, we are creating intervals corresponding to the numbers between the current <code>x</code>/<code>y</code> values and the next (lines 11-12). As mentioned above, Frink&rsquo;s support for intervals is transparent, so we can apply <code>lhs</code> and <code>rhs</code> to the intervals in the very same way as we did in <code>naivePlot</code>. But now, instead of using a tolerance value to compare the results, we are using the operator <code>PEQ</code>, which stands for &ldquo;Possibly EQuals&rdquo;, i.e. it tests whether the compared intervals have some overlap. This is one of a number interval-specific operators defined in Frink (for the full list see the <a href="https://futureboy.us/frinkdocs/#IntervalComparisonOperators">documentation</a>).</p>

<p>In the context of plotting, <code>PEQ</code> is exactly what we need; given that interval arithmetic produces the right bounds, there is no way for our code to miss solutions to the equation. To make this point more clear, we can consider two single-variable functions, <code>f</code> and <code>g</code> (which for simplicity we assume to be continuous). In the previous section, it was natural to view intervals as values with an uncertainty or a measurement error. But there is another way to look at them: an interval simultaneously represents all values in its range. With this interpretation, the expression <code>f([3, 5])</code> is equivalent to sampling the function on the whole range of <code>[3, 5]</code>. That is, the interval <code>f([3, 5])</code> contains all values that <code>f</code> can take on the range <code>[3, 5]</code>. So the assertion that <code>f([3, 5]) PEQ g([3, 5]) == false</code> means that nowhere in the interval <code>[3, 5]</code> the functions <code>f</code> and <code>g</code> can be equal. That is, <code>PEQ</code> guarantees us that there is no solution to the equation <code>f = g</code> in this interval. The converse statement, <code>f([3, 5]) PEQ g([3, 5]) == true</code>, is not as strong, it only tells us that <code>[3, 5]</code> may contain a solution to the equation, but it is not guaranteed (thanks to <a href="https://twitter.com/aeliasen">Alan Eliasen</a> for clarifying this point). In the code above we assume that the solution does indeed exist, and we mark it on the plot (which may yield false positives if the resulting intervals are not tight enough; though that&rsquo;s beyond the scope of this post). In this way, we can achieve (paraphrasing the comment <a href="http://mrhonner.com/archives/11643#comment-3980">here</a>) a &ldquo;step-perfect&rdquo; plot &ndash; if a solution to the equation exists within a step, <code>PEQ</code> cannot miss it (which contrasts probabilistic sampling methods, like <code>naivePlot</code>, that can miss possible solutions). Since in <code>intervalPlot</code> we are covering the whole plot range with intervals, we should see all solutions to the equation within the range.</p>

<p>Okay, but that&rsquo;s all just theory, what we really need is proof, and what can better serve as a proof than a picture. For the code</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>intervalPlot[lhs, rhs, xMin, xMax, yMin, yMax, 300, 300]</span></code></pre></td></tr></table></div></figure>


<p>we get:</p>

<p><img class="center" src="http://ncreep.github.io/language_perils/images/frink/interval_e1_300.png"></p>

<p>Which is a bit crude, since we are not making that many steps. We should remember though, that for the equivalent step size in the naive approach, we got almost nothing at all. Here, as promised, we are not missing any solutions in the whole range. It is possible to refine the plot by increasing the step size:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>intervalPlot[lhs, rhs, xMin, xMax, yMin, yMax, 800, 800]</span></code></pre></td></tr></table></div></figure>


<p>and yield:</p>

<p><img class="center" src="http://ncreep.github.io/language_perils/images/frink/interval_e1_800.png"></p>

<p>Which is quite amazing, since this solution is as simple to implement as the naive solution, but it doesn&rsquo;t require us to muck about with tolerance values and step sizes, the burden of heavy lifting is on the implementation of interval arithmetic.</p>

<p>All this power at my fingertips&hellip; Let&rsquo;s try to plot something more ambitious. For this, we&rsquo;ll define the following functions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* A Gaussian function in one dimension */
</span><span class='line'>gaussian[a, x] := exp[-x^2 / a^2]
</span><span class='line'>
</span><span class='line'>/* A 2d Gaussian centered at (x0, y0) */
</span><span class='line'>gaussian2d[a, x, x0, y, y0] := gaussian[a, x - x0] gaussian[a, y - y0]
</span><span class='line'>
</span><span class='line'>/* A sum of 2d Gaussians with peaks at different locations. 
</span><span class='line'> * `peaks` is a list of pairs designating the positions of the peaks. 
</span><span class='line'> */
</span><span class='line'>gaussians[a, x, y, peaks] :=
</span><span class='line'>{
</span><span class='line'>  res = 0
</span><span class='line'>  for [x0, y0] = peaks
</span><span class='line'>  {
</span><span class='line'>     res = res + gaussian2d[a, x, x0, y, y0]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  return res
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/* A 2d surface with bumps at integer locations. */
</span><span class='line'>bumps[x, y] := cos[2 pi x] cos[2 pi y]</span></code></pre></td></tr></table></div></figure>


<p>Which is just a bunch of different bumpy functions. The sides of the equation that we will be plotting now are:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lhs = { |x, y| bumps[x, y] }
</span><span class='line'>rhs = { |x, y| 2 - gaussians[0.01, x, y, peaks[]] }</span></code></pre></td></tr></table></div></figure>


<p>Where <code>peaks[]</code> is a list of pairs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>peaks[] := [[1, 1], [1, 2], [1, 3], [1, 4], [1, 5], [2, 4], [3, 3], [4, 4], [5, 1], [5, 2], [5, 3], [5, 4], [5, 5], 
</span><span class='line'>            [7, 1], [7, 2], [7, 3], [7, 4], [7, 5], [8, 3], [8, 5], [9, 3], [9, 5], [10, 1], [10, 2], [10, 3], [10, 4], [10, 5], 
</span><span class='line'>            [12, 1], [12, 2], [12, 3], [12, 4], [12, 5], [13, 1], [13, 5], [14, 1], [14, 3], [14, 5], [15, 1], [15, 2], [15, 3], [15, 5], 
</span><span class='line'>            [17, 1], [17, 2], [17, 3], [17, 4], [17, 5],
</span><span class='line'>            [19, 1], [19, 2], [19, 3], [19, 4], [19, 5], [20, 1], [20, 5], [21, 1], [21, 5]]</span></code></pre></td></tr></table></div></figure>


<p>The exact details of the various functions are not that important, what&rsquo;s important is that both <code>lhs</code> and <code>rhs</code> can be evaluated on intervals, and so can be plotted by <code>intervalPlot</code>. But first, let&rsquo;s see what <code>naivePlot</code> can make of it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xMin = 0
</span><span class='line'>xMax = 23
</span><span class='line'>
</span><span class='line'>yMin = 0
</span><span class='line'>yMax = 6
</span><span class='line'>
</span><span class='line'>xSteps = 50
</span><span class='line'>ySteps = 50
</span><span class='line'>
</span><span class='line'>naivePlot[lhs, rhs, xMin, xMax, yMin, yMax, xSteps, ySteps]</span></code></pre></td></tr></table></div></figure>


<p>Since this function takes longer to evaluate, I won&rsquo;t bother with a larger step. And the result:</p>

<p><img class="center" src="http://ncreep.github.io/language_perils/images/frink/naive_e2_50.png"></p>

<p>One would&rsquo;ve thought that with all the fuss defining the functions above, we&rsquo;d have something more interesting as a result, oh well&hellip;</p>

<p>Let&rsquo;s try <code>intervalPlot</code> with the same step:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>intervalPlot[lhs, rhs, xMin, xMax, yMin, yMax, xSteps, ySteps]</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://ncreep.github.io/language_perils/images/frink/interval_e2_50.png"></p>

<p>Now that&rsquo;s magic!</p>

<p>Okay, okay, I know, it&rsquo;s a bit gimmicky. Also, you might be thinking that defining some pathological function and then comparing the performance of the interval arithmetic solution to the joke of a plotting function that I came up with doesn&rsquo;t really prove anything. And you&rsquo;d be right, it is a somewhat inadequate comparison (though I would like to point out again how ridiculously simple <code>intervalPlot</code>&rsquo;s implementation is). If only I had something more solid to compare to.</p>

<p>I&rsquo;m sure that most would agree that <a href="http://www.wolframalpha.com/">WolframAlpha</a> knows a thing or two about plotting. Let&rsquo;s see how it compares to <code>intervalPlot</code>. Though it would be a bit tedious to submit our complete functions to WolframAlpha, so we&rsquo;ll simplify a bit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lhs = { |x, y| bumps[x, y] }
</span><span class='line'>rhs = { |x, y| 2 - guassian2d[0.01, x, 1, y, 1] }
</span><span class='line'>
</span><span class='line'>xMin = 0
</span><span class='line'>xMax = 2
</span><span class='line'>
</span><span class='line'>yMin = 0
</span><span class='line'>yMax = 2
</span><span class='line'>
</span><span class='line'>xSteps = 50
</span><span class='line'>ySteps = 50</span></code></pre></td></tr></table></div></figure>


<p>Which is essentially the same as before, except that on line 2 we&rsquo;re not using <code>peaks[]</code> anymore, but just a single peak. We can run</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>intervalPlot[lhs, rhs, xMin, xMax, yMin, yMax, xSteps, ySteps]</span></code></pre></td></tr></table></div></figure>


<p>and get:</p>

<p><img class="center" src="http://ncreep.github.io/language_perils/images/frink/interval_e3_50.png"></p>

<p>As of writing, <a href="http://www.wolframalpha.com/input/?i=ContourPlot%5BCos%5B2+Pi+x%5D+Cos%5B2+Pi+y%5D+%3D%3D+2+-+Exp%5B-%28x+-+1%29^2%2F%280.01%29^2%5D+Exp%5B-%28y+-+1%29^2%2F%280.01%29^2%5D%2C+{x%2C+0%2C+2}%2C+{y%2C0%2C+2}%5D">running the equivalent expression</a> on WolframAlpha yields the following:</p>

<p><img class="center" src="http://ncreep.github.io/language_perils/images/frink/wolfram_alpha_e3.png" width="320" height="320"></p>

<p>Although I&rsquo;ve no idea how Mathematica (and by extension WolframAlpha) implements plotting for this sort of thing, I&rsquo;m sure that it&rsquo;s not anywhere nearly as simple as our toy interval arithmetic function.</p>

<p>(Ironically, for the data above, <code>naivePlot</code> actually produces a plot with a point in the middle; but that&rsquo;s not really a meaningful result, but rather a coincidence, since even a minor tweak, e.g. <code>xSteps = 51</code>, makes the point disappear. <code>intervalPlot</code>, is, obviously, insensitive to such tweaks.)</p>

<p>Having said all that, I&rsquo;m not actually knowledgeable enough to be actively recommending interval arithmetic plotting solutions as a drop-in replacements for anything else. As in any other non-trivial numerical problem, I&rsquo;m sure that this area has its own set of nuances, which were not apparent in the examples used in this post. Probably, the best approach to plotting is some combination of various techniques. But still, I find it quite intriguing that we managed to get so far with such a small investment.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello Frink]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2015-01-08-hello-frink.html"/>
    <updated>2015-01-08T16:54:37+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/hello-frink</id>
    <content type="html"><![CDATA[<p>In this post, I&rsquo;ll be introducing the <a href="https://futureboy.us/frinkdocs/">Frink</a> programming language. As stated on Frink&rsquo;s homepage:</p>

<blockquote><p>Frink is a practical calculating tool and programming language designed to make physical calculations simple, to help ensure that answers come out right, and to make a tool that&rsquo;s really useful in the real world. It tracks units of measure (feet, meters, kilograms, watts, etc.) through all calculations, allowing you to mix units of measure transparently, and helps you easily verify that your answers make sense. It also contains a large data file of physical quantities, freeing you from having to look them up, and freeing you to make effortless calculations without getting bogged down in the mechanics.</p></blockquote>

<p>So Frink&rsquo;s &ldquo;killer feature&rdquo; is that you can write something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>12.5 kilotons TNT / (6 years + 9 months) -&gt; horsepower
</span><span class='line'>// 329.48048477017130757</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>Although Frink is a full-featured programming language, including some support for object-oriented and functional programming, in this introductory post we&rsquo;ll be focusing only on Frink&rsquo;s ability to handle units. Since Frink&rsquo;s syntax should be pretty intuitive to anyone coming from the world of C-like languages, in future posts about Frink, I&rsquo;ll introduce new syntax as it comes up. (For some distant future readers living in a world where C-like syntax is long forgotten and Javascript is buried in the unreachable depths of the Internet Archive, if you haven&rsquo;t got a clue what I&rsquo;m on about, I envy you.)</p>

<p>First things first, anything Frink related, including documentation and an interpreter, can be found on its <a href="https://futureboy.us/frinkdocs/">homepage</a>. Simple calculations can be run directly on the <a href="https://futureboy.us/fsp/frink.fsp">web interface</a>. Having set up a working environment (note that Frink is very frequently updated, hopefully, the code written here won&rsquo;t get dated too soon), we can move on to the premises of our exploratory session.</p>

<p><em><u>Clarification</u>: the author of the text below is not completely out of his mind, despite evidence to the contrary.</em></p>

<p>Without further ado, the premises: we&rsquo;ll be trying to come up with a totally scientific method of making money (&ldquo;&hellip;using this one weird trick discovered by a mad scientist&hellip;&rdquo;), lots and lots of shiny money. I&rsquo;ll outline the revenue-generating method, and we&rsquo;ll use Frink to perform back-of-the-proverbial-napkin calculations to see how profitable it is (where, in our case, the &ldquo;napkin&rdquo; includes a computer and an internet connection). There will be some code soon, bear with me.</p>

<p>It&rsquo;s common practice to make money from currency exchange, which can be thought of as taking advantage of geography to make money. Looking at it from a slightly different angle, we are using some form of spatial relationships to generate profit. Since in physics there isn&rsquo;t much difference between space and time, why can&rsquo;t we use temporal relationships to earn money? &ldquo;Ah&rdquo;, you might say, &ldquo;he must mean stock trading&rdquo;. But no, that&rsquo;s too well-trodden a path to take, and it&rsquo;s not that interesting anyways. What I propose is to use time travel, specifically, time travel to the past, to generate profit. A naive approach might include using current stock market information to make money in the past, but I don&rsquo;t consider it to be a viable approach, since if you&rsquo;re too successful you&rsquo;re likely to get caught and be sent to jail for insider trading or something; and that&rsquo;s not cool at all. Another method would be to go to the past with a bunch of current dollars, and use the dollars&#8217; increased buying ability in the past to import some goods into the future. But using money from the future might raise suspicion as well. So we&rsquo;ll use a more subtle approach.</p>

<p>The method relies on the fact that prices of various goods vary differently over time. As a reference for historical prices, we&rsquo;ll use this table (adapted from <a href="http://www.infoplease.com/ipa/A0873707.html">here</a>, all prices are given in dollars):</p>

<pre>
| Year | Bread (lbs) | Potatoes (10 lbs) |
|------|-------------|-------------------|
| 2010 | 1.41        | 5.79              |
| 1920 | 0.115       | 0.630             |
</pre>


<p>So to make money, we can do the following:</p>

<ul>
<li>For <code>$5.79</code>, buy <code>10</code> pounds of potatoes today (which, according to the table, is 2010, but that&rsquo;s beside the point)</li>
<li>Go back to 1920 and sell the potatoes for <code>$0.63</code></li>
<li>Buy <code>0.63 / 0.115 = 5.47</code> pounds of bread</li>
<li>Return to the present and sell our bread for <code>$7.7</code></li>
</ul>


<p>Having executed this simple procedure, we just made a hefty profit of <code>7.7 - 5.79 = 1.91</code> dollars.</p>

<p>Of course, nothing is that simple, we should further explore this scenario.
For starters, we should convert our table into some Frink code. We could write something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>breadNow = 1.41
</span><span class='line'>bread1920 = 0.115
</span><span class='line'>
</span><span class='line'>potatoesNow = 5.79
</span><span class='line'>potatoes1920 = 0.630
</span><span class='line'>
</span><span class='line'>// there are more civilized methods to import external data into Frink
</span><span class='line'>// but that'll do for now</span></code></pre></td></tr></table></div></figure>


<p>You might note that these are just plain numbers; given how Frink is all about the physical units, we should probably give these numbers some concrete units. We could use the units actually provided in the table, but as someone once said:</p>

<blockquote><p>If God had wanted us to use the metric system, he would have given us 10 fingers and 10 toes</p></blockquote>

<p>(Though the distinguished scientist Frink, who lent his name to the Frink language, actually has 8 fingers, not sure what that implies&hellip;)</p>

<p>Luckily, unit conversion is deeply ingrained into Frink. Let&rsquo;s start with bread &ndash; the units implied by the table are dollar per lbs, writing this down in the interpreter gives us:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dollar / lbs
</span><span class='line'>// 100000000/45359237 (approx. 2.2046226218487758) kg^-1 dollar (price_per_mass)</span></code></pre></td></tr></table></div></figure>


<p>So no need for conversions, MKS is the (very sane) default. We can write down the rest of the values in the same manner:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Frink recognizes juxtaposition as multiplication
</span><span class='line'>
</span><span class='line'>breadNow = 1.41 dollar / lbs
</span><span class='line'>bread1920 = 0.115 dollar / lbs
</span><span class='line'>
</span><span class='line'>potatoesNow = 5.79 dollar / (10 lbs)
</span><span class='line'>potatoes1920 = 0.630 dollar / (10 lbs)</span></code></pre></td></tr></table></div></figure>


<p>And now we have all of our data with proper units. We can describe our money making scheme using Frink, though we&rsquo;ll be trying to rake in more profit now:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>moneyInvested = tonne potatoesNow
</span><span class='line'>// 1276.4764980504411924 dollar (currency)
</span><span class='line'>
</span><span class='line'>moneyFromPotatoes = tonne potatoes1920
</span><span class='line'>// 138.89122517647287585 dollar (currency)
</span><span class='line'>
</span><span class='line'>breadBought = moneyFromPotatoes / bread1920
</span><span class='line'>// 547.82608695652173911 kg (mass)
</span><span class='line'>
</span><span class='line'>moneyFromBread = breadBought breadNow
</span><span class='line'>// 1702.9271956419717822 dollar (currency)
</span><span class='line'>
</span><span class='line'>moneyMade = moneyFromBread - moneyInvested
</span><span class='line'>// 426.4506975915305898 dollar (currency)</span></code></pre></td></tr></table></div></figure>


<p>Ha, it works! We&rsquo;ve just made ourselves about 430 dollars, and all it took is to buy a mere tonne of potatoes. Well almost, I&rsquo;m ignoring the fact that we actually don&rsquo;t have a time machine. Speaking of which, though I&rsquo;ve little experience with actual time travel, I would imagine that, just like in space travel, in a real time machine (and not those made-up ones you see in the movies) the allowed weight and volume on a mission would be seriously constrained.</p>

<p>We know how much weight we&rsquo;ll be carrying, but how much volume would that make? Simple enough, we just need the densities of bread and potatoes, which can be found, for example, <a href="http://www.fao.org/docrep/017/ap815e/ap815e.pdf">here</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bread = 0.29 g / ml
</span><span class='line'>potato = 0.59 g / ml</span></code></pre></td></tr></table></div></figure>


<p>And so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>548 kg / bread // 1.8896551724137931034 m^3 (volume)
</span><span class='line'>tonne / potato // 1.6949152542372881356 m^3 (volume)</span></code></pre></td></tr></table></div></figure>


<p>From which we can conclude that bread is the constraining element here. But these numbers are a bit meaningless; we need to compare them to something familiar. An average fridge is about 20 cubic feet, converting manually is simple enough (I&rsquo;m using weird American units just to show that Frink doesn&rsquo;t scare easily):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(548 kg / bread) / (20 cubic feet)
</span><span class='line'>// 3.3366271316165081822</span></code></pre></td></tr></table></div></figure>


<p>But we don&rsquo;t actually need to bother with manual unit conversion, since Frink has a nifty unit conversion operator: <code>-&gt;</code>. For example, we can write:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1.67 meter -&gt; feet 
</span><span class='line'>// 5.4790026246719160105</span></code></pre></td></tr></table></div></figure>


<p>Adding quotes on the right-hand side gives a bit of nice formatting:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1.67 meter -&gt; "feet" 
</span><span class='line'>// 5.4790026246719160105 feet</span></code></pre></td></tr></table></div></figure>


<p>Note that the result is a string value and not a number.</p>

<p>What&rsquo;s even nicer is that the right-hand side can contain an arbitrary numeric expression with compatible units, so we are not limited to just built-in units. Back to our example, we can write it as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>548 kg / bread -&gt; 20 cubic feet
</span><span class='line'>// 3.3366271316165081822</span></code></pre></td></tr></table></div></figure>


<p>We can also define our own custom unit for fridge related measurements (which come up quite often, so definitely a worthwhile investment) and have:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fridge = 20 cubic feet
</span><span class='line'>
</span><span class='line'>548 kg / bread -&gt; "fridge"
</span><span class='line'>// 3.3366271316165081822 fridge</span></code></pre></td></tr></table></div></figure>


<p>Making our 430 dollars would require us to carry 3 fridges full of bread, from 90 years back in the past. Fair enough, nothing comes for free; making a bit of an effort for money builds character, or something.</p>

<p>Let&rsquo;s get more ambitious, we can arrange our retirement with a big score of 1 million dollars (and when I say &ldquo;our&rdquo;, I mean &ldquo;my&rdquo;, since it&rsquo;s my plan, I&rsquo;m just thinking out loud here). Rearranging the equations from the previous excursion to the past, we have:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>potatoesToBuy = 1 million dollar / (potatoes1920 breadNow / bread1920 - potatoesNow)
</span><span class='line'>potatoesToBuy -&gt;  "tonne"
</span><span class='line'>// 2344.9369543717689376 tonne</span></code></pre></td></tr></table></div></figure>


<p>Whoa, that&rsquo;s a lot of potatoes, let&rsquo;s see how many fridges we&rsquo;ll need:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>potatoesToBuy / potato -&gt; "fridge"
</span><span class='line'>// 7017.8531378425014657 fridge</span></code></pre></td></tr></table></div></figure>


<p>And it gets worse with the bread we&rsquo;ll have to carry back from the past:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>breadVolume = potatoesToBuy potatoes1920 / bread1920 / bread
</span><span class='line'>breadVolume -&gt; "fridge"
</span><span class='line'>// 7821.6971854154656513 fridge</span></code></pre></td></tr></table></div></figure>


<p>At these volumes, fridges become a bit meaningless as well; I, personally, have never seen so many fridges in one place (if you did, you can share this bizarre experience in the comments). A <a href="http://en.wikipedia.org/wiki/Space_Shuttle_external_tank">space shuttle fuel tank</a> is about 2.6 million liters:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>spaceFuelTank = 2.6 million liters
</span><span class='line'>
</span><span class='line'>breadVolume -&gt; "spaceFuelTank"
</span><span class='line'>// 1.7037369176037532356 spaceFuelTank</span></code></pre></td></tr></table></div></figure>


<p>Hmm, 2 space shuttle fuel tanks, that&rsquo;s a lot. Makes me wonder&hellip; If a human can be &ldquo;fueled&rdquo; by bread or potatoes, can we fuel a space shuttle with them?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// food calories, as apposed to regular calories, are written with a capital 'C'
</span><span class='line'>breadCalories = 260 Calories / (100 gram)
</span><span class='line'>potatoCalories = 80 Calories / (100 gram)
</span><span class='line'>
</span><span class='line'>// rocket fuel
</span><span class='line'>liquidH2 = 8.5 MJ / L
</span><span class='line'>
</span><span class='line'>fullFuelTank = liquidH2 spaceFuelTank
</span><span class='line'>
</span><span class='line'>bread breadCalories spaceFuelTank -&gt; "fullFuelTank"
</span><span class='line'>// 0.37139378823529411764 fullFuelTank
</span><span class='line'>
</span><span class='line'>potato potatoCalories spaceFuelTank -&gt; "fullFuelTank"
</span><span class='line'>// 0.23249054117647058823 fullFuelTank</span></code></pre></td></tr></table></div></figure>


<p>Not bad, of the two, bread seems to be the better alternative to rocket fuel; although we&rsquo;ll need more than two tanks of bread to compensate for its inefficiency (this is not, hmm, quite accurate, since in an actual fuel tank, not all volume is taken by liquid hydrogen, but, whatever). I won&rsquo;t take any responsibility for the consequences of actually trying to send a space mission on pure bread fuel; I am willing to take credit if it works out, though.</p>

<p>Anyways, we got a bit sidetracked by a somewhat ridiculous idea &ndash; back to our more serious business plans. So making one big score and retiring doesn&rsquo;t seem to be in our cards. We&rsquo;ll probably have to devise some working schedule and move our goods in batches; time travel can really become a 9-to-5 job. But still, for now, it&rsquo;s a niche market, I&rsquo;m sure that profit is guaranteed.</p>

<p>Since it&rsquo;s a 9-to-5 job, we can try to figure out what our daily commute would be like. Judging by various movies, it seems that time travel is nearly instantaneous, but that&rsquo;s ridiculous, one&rsquo;s daily commute can&rsquo;t be that fast (I&rsquo;m sure there&rsquo;s a law of physics that governs that). I propose a more reasonable rate of half an hour per one year traveled into the past. So traveling ninety years back takes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ninety years (half hour / year) -&gt; "hours"
</span><span class='line'>// 45.0 hours</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s quite the commute, but we&rsquo;re aiming for much profit, so that&rsquo;s how it is.</p>

<p>One small wrinkle though, in the calculations above, we didn&rsquo;t account for the monetary investment in actual time travel. Let&rsquo;s sort this out. For the present discussion, I&rsquo;ll ignore the one-time investment of actually obtaining a time machine; as it&rsquo;s just a minor technical detail, a bit of research and engineering should settle it. Given that we are probably going to make many time trips, I would like to have an estimate of how much a single trip actually costs.</p>

<p>In physics, when one goes between time and space values, one uses the speed of light (<code>c</code>) as a conversion factor. We&rsquo;re going to stretch this analogy (till it utterly bursts) to provide some estimates for the energy consumption of a time trip.</p>

<p>Since we are not actually moving, I think it&rsquo;s reasonable to assume that time travel doesn&rsquo;t have any friction (like air friction when flying). If one day someone discovers some kind of &ldquo;time friction&rdquo;, we&rsquo;ll have to modify our calculations accordingly. But for now, ignoring friction, we can estimate the energy consumption of our trip just by knowing the difference in the required &ldquo;velocities&rdquo;. The starting point is that we are moving forwards in time at a rate of one second per second. What we want to achieve, is a movement backwards in time one year per half hour, and of course, we need not forget to convert everything to velocity values using the speed of light:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>startVelocity = c second / second
</span><span class='line'>targetVelocity = -c year / (half hour)</span></code></pre></td></tr></table></div></figure>


<p>We can plug our &ldquo;velocities&rdquo; into the formula for kinetic energy (<code>m/2 v^2</code>) and take the difference for our energy consumption. Assuming that the payload is a tonne of potatoes, we have:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>timeTravelEnergy = tonne/2 (targetVelocity^2 - startVelocity^2)
</span><span class='line'>// 1.3811974908674380205e+28 m^2 s^-2 kg (energy)</span></code></pre></td></tr></table></div></figure>


<p>Which is the energy we need to invest to accelerate back in time. We could similarly ballpark the return trip, but that <code>e+28</code> in the result looks really suspicious. Let&rsquo;s try to see what it means:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// the atomic bomb dropped on Hiroshima
</span><span class='line'>littleBoy = 15 kilotons TNT
</span><span class='line'>
</span><span class='line'>timeTravelEnergy -&gt; "littleBoy"
</span><span class='line'>// 2.1992890208392057905e+14 littleBoy
</span><span class='line'>
</span><span class='line'>// not even close...
</span><span class='line'>
</span><span class='line'>// a hydrogen bomb, the most powerful nuclear weapon ever detonated
</span><span class='line'>tsarBomba = 50 megatons TNT
</span><span class='line'>
</span><span class='line'>timeTravelEnergy -&gt; "tsarBomba"
</span><span class='line'>// 6.5978670625176173713e+10 tsarBomba
</span><span class='line'>
</span><span class='line'>// nope
</span><span class='line'>
</span><span class='line'>// world energy consumption in the years 1980 - 2012
</span><span class='line'>worldEnergyConsumption = 12676 quadrillion Btu
</span><span class='line'>
</span><span class='line'>timeTravelEnergy -&gt; "worldEnergyConsumption"
</span><span class='line'>// 1.0327568857509895368e+6 worldEnergyConsumption
</span><span class='line'>
</span><span class='line'>// nah ah
</span><span class='line'>
</span><span class='line'>// the asteroid that killed the dinosaurs
</span><span class='line'>chicxulubImpact = 100 teratons TNT
</span><span class='line'>
</span><span class='line'>timeTravelEnergy -&gt; "chicxulubImpact"
</span><span class='line'>// 32989.335312588086856 chicxulubImpact
</span><span class='line'>
</span><span class='line'>// getting warmer (pun intended)...
</span><span class='line'>
</span><span class='line'>energyToEvaporateAllOceans = 3 octillion joules
</span><span class='line'>
</span><span class='line'>timeTravelEnergy -&gt; "energyToEvaporateAllOceans"
</span><span class='line'>// 4.6039916362247934016 energyToEvaporateAllOceans</span></code></pre></td></tr></table></div></figure>


<p>(the figures above come from <a href="http://en.wikipedia.org/wiki/Little_Boy">a</a> <a href="http://en.wikipedia.org/wiki/Tsar_Bomba">number</a> <a href="http://www.eia.gov/cfapps/ipdbproject/IEDIndex3.cfm?tid=44&amp;pid=44&amp;aid=2">of</a> <a href="http://en.wikipedia.org/wiki/Chicxulub_crater">various</a> <a href="http://scientificlogic.blogspot.co.il/2010/04/how-much-heat-is-needed-to-vaporize.html">sources</a>)</p>

<p>Got it! So all we need to power our little business trip is the energy equivalent of evaporating all oceans on Earth, five times. Right. So how does <em>that</em> affect our revenue? Assuming we&rsquo;ll be using rocket fuel for our travels:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>liquidH2Price = 3 dollar / kg
</span><span class='line'>liquidH2SpecificEnergy = 142 MJ / kg
</span><span class='line'>
</span><span class='line'>requiredFuel = timeTravelEnergy / liquidH2SpecificEnergy
</span><span class='line'>
</span><span class='line'>fuelMoney = requiredFuel liquidH2Price
</span><span class='line'>
</span><span class='line'>totalRevenue = moneyMade - fuelMoney
</span><span class='line'>// -2.9180228680297986306e+20 dollar (currency)</span></code></pre></td></tr></table></div></figure>


<p>Well, that sucked&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Joy No More]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2014-03-24-joy-no-more.html"/>
    <updated>2014-03-24T03:46:15+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/joy-no-more</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve reached the end of my Joy escapade. I can definitely say that I had a great time (notice how I avoided one of my well-trodden puns here) figuring out this nifty little language.</p>

<!-- more -->


<p>Joy is a demonstration of how far a powerful and clean idea can take you. Being a (sadly) abandoned research language, it&rsquo;s definitely not as polished as some other industrial-grade alternatives, say, <a href="http://factorcode.org/">Factor</a>, but its elegance cannot be disputed. It&rsquo;s a real eye opener to see how easily concatenative code can be reasoned about by just breaking it down in an arbitrary place, and expanding any non-obvious expressions, then rinsing and repeating, until you figure out whatever requires figuring out. It takes time to get used to the (theoretically optional) stack, and I can&rsquo;t really say it grows on you, at least not within the short period of time I&rsquo;ve been exposed to it. But once you get your handle on it and reach the right level of abstraction for your domain, it kind of fades more into the background.</p>

<p>On the other side of the feature-set spectrum, there is the power of homoiconicity and quoting, which was plentifully used and abused in all of the Joy posts, but especially in the <a href="http://ncreep.github.io/language_perils/blog/2013-05-24-meta-joy.html">metaprogramming post</a> (partially undermining the ease of reasoning point above). These minimal features give you plenty of rope to hang yourself, but the flexibility you gain is way more than worth it. The experience of <a href="http://ncreep.github.io/language_perils/blog/2014-03-20-domain-specific-joy.html">writing a DSL</a> in Joy is one proof of that.</p>

<p>Joy does have its warts, mostly due to its lack of proper tooling; debugging non-trivial code without even line numbers for the errors and with possible bugs in the interpreter is not a great source of joy (see what I did there? Couldn&rsquo;t help it). But you get over it, and the relative ease of reasoning, at least up to the point when you go too meta, alleviates some of the pain.</p>

<p>Nonetheless, I still recommend learning Joy for both fun and profit (not in the monetary sense, we&rsquo;re all idealists here&hellip;); it&rsquo;s a very enlightening experience for a very small entrance fee. Maybe in the future I&rsquo;ll get myself into some more concatenative programming, there&rsquo;s plenty more to dig into. I already mentioned Factor as a more feature-complete alternative. But being more inclined towards static typing, the <a href="http://www.cat-language.com/">Cat</a> programming language looks like an appealing option.</p>

<p>Anyways, that&rsquo;s all I have to say about Joy in this series; it&rsquo;s time to choose my next language.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Domain-specific Joy]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2014-03-20-domain-specific-joy.html"/>
    <updated>2014-03-20T05:10:59+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/domain-specific-joy</id>
    <content type="html"><![CDATA[<p>In this post, our goal is to create a domain-specific language (DSL) for the state machine domain that we introduced in the last <a href="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html">post</a>. We already had a working example of a state machine (a totally realistic model of a baby), which suffered from being rather verbose and far from cleanly expressing our target domain.</p>

<p>To actually have a language, we need some kind of a syntax for it. In our case, we already have a nice textual representation of the domain, which is the <a href="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html#baby-table">ASCII table</a> format I used to describe the different baby states (funny coincidence how that worked out so comfortably well). This format solves the repetitiveness issues and is definitely close to our domain.</p>

<!-- more -->


<p>To simplify the thought process, let&rsquo;s have a smaller example of a state machine:</p>

<pre>
  || a | b |
============
1 || b | a |
2 || b | b |
</pre>


<p>This time, we have only two states (<code>a</code>, <code>b</code>) and two inputs (<code>1</code>, <code>2</code>), and we do not use the stack for anything. Simple enough for our purposes here.</p>

<p>Now, Joy&rsquo;s syntax, or lack thereof, makes it possible to write this thing as is by just quoting it all into a list:</p>

<pre>
[ || a | b |
============
1 || b | a |
2 || b | b | ]
</pre>


<p>Or how Joy really sees it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[|| a | b | ============ 1 || b | a | 2 | | b | b |]</span></code></pre></td></tr></table></div></figure>


<p>This works because quotes are not checked for invalid identifiers; they only need to contain valid Joy syntax, and that&rsquo;s exactly what we have in our table (which is yet another amazing coincidence). Next, we can try to parse the contents of the quote and convert it into something that is runnable with our state machine runner. But that&rsquo;s not a direction I would actually want to pursue. By doing this, we are not taking any advantage of Joy itself for language representation &ndash; we are just using it as a fancy tokenizer for what is essentially plain text. And that&rsquo;s practically an external DSL. I find external DSLs much less interesting than embedded DSLs, as they give us less chances to flex our language&rsquo;s syntax muscles. Let us come up with a proper embedded DSL.</p>

<p>As a first step in this direction, we can remove all the fluff from the table above, and convert it into a plain list of lists:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ [a b] [1 b a] [2 b b] ]</span></code></pre></td></tr></table></div></figure>


<p>This is a valid representation of the data from before, but the grouping is wrong. In the code we wrote in the <a href="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html#baby-states">previous post</a>, each state had all its possible inputs grouped around it. What we have here is the opposite. By transposing the table, we get the right grouping:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ [1 2] [a b b] [b a b] ]</span></code></pre></td></tr></table></div></figure>


<p> Which corresponds to the transposed table:</p>

<pre>
  || 1 | 2 |
============
a || b | b |
b || a | b |
</pre>


<p>It&rsquo;s not that complicated to write a transposing function to achieve this transformation, but for simplicity, let us just work with transposed tables to begin with.</p>

<p>Having an abstract way to represent the required data is quite a common thing when creating a DSL. From here, we need to proceed in two directions. The first one is creating some nice syntax for constructing the data. The second is converting the data into something executable.</p>

<p>Before we can proceed with either of those, we still have some aspects of our domain unattended: we don&rsquo;t have a way to do anything on the stack. We&rsquo;ll take the following approach: each cell is going to be implicitly executed on the current stack, so everything we leave there stays on the stack. The last thing on the stack is going to be the next state. We can embellish our simple state machine with some stack actions like so:</p>

<pre>
  ||   1   |    2  |
====================
a ||  0  b | pop b |
b || pop a |  0  b |
</pre>


<p>Now, in the <code>a</code> state when the input is <code>1</code>, it pushes <code>0</code> on the stack and moves to <code>b</code>, and when the input is <code>2</code>, it pops a value from the stack and also moves to <code>b</code>. The <code>b</code> state acts analogously. Converting this into our list representation gives us:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ [1 2] [ a [0  b] [pop b] ] [ b [pop a] [0  b] ] ]</span></code></pre></td></tr></table></div></figure>


<p>To group all of its action into a single piece of data, each cell has to be quoted now.</p>

<p>Because we are dealing with a very simple data structure, creating a palatable syntax for it shouldn&rsquo;t be too complicated, so we&rsquo;ll get to it first. Without further ado, here&rsquo;s the syntax:</p>

<pre>
    @     1    |    2    |
[a] : [  0  b ]|[ pop b ]|
[b] : [ pop a ]|[  0  b ]|
</pre>


<p>(the code for the DSL can be found in <a href="https://github.com/ncreep/language_perils/blob/master/Joy/state_machine/state_machine_table_dsl.joy">state_machine_table_dsl.joy</a>)</p>

<p>All of it is completely valid Joy syntax and creates the following list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[[0 b] [pop a] "b"] [[pop b] [0 b] "a"] [2 1]]</span></code></pre></td></tr></table></div></figure>


<p>Oops, our lists seem to be inverted. No biggie, this is as good a data representation as any other. It just happens to be that it&rsquo;s easier to construct things in reverse when dealing with cons lists.</p>

<p>Let&rsquo;s delve into our syntax a bit further. The <code>@</code> pushes our initial value onto the stack, which is a <code>[[]]</code>; all further actions will be adding stuff to this value. The <code>|</code> symbol prepends the current thing on the stack to our nested list, e.g.:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@ 1 |     # =&gt; [ [1] ]
</span><span class='line'>@ 1 | 2 | # =&gt; [ [2 1] ]</span></code></pre></td></tr></table></div></figure>


<p>The names of the states are now quoted; otherwise we won&rsquo;t be able to put them on the stack as we are doing while constructing the table (once they are on the stack, they get evaluated, but the state names don&rsquo;t have any meaning, so that just gets us an error, possibly a silent one).</p>

<p>The <code>:</code> starts a new row; it converts the preceding symbol into a string and adds it to a new list in our nested list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[2 1]] [a] :   # =&gt; [ ["a"] [2 1] ]</span></code></pre></td></tr></table></div></figure>


<p>Converting the symbol into a string makes it a bit simpler to work with it further down the road. Notice that the references to the state names in the cells remain as is; we&rsquo;ll have to deal with those later.</p>

<p>And that&rsquo;s all there is to it. This syntax is close enough to the ASCII table format we started with, and contains very little noise. This was the easy bit; now we actually have to turn this into something we can execute.</p>

<p>I&rsquo;ll spare you the gory details of the transformation and focus on the more interesting bits. Having obtained our abstract representation, we convert it, using some not too complicated list manipulation code (the beauty of homoiconicity&hellip;), into the following construct:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[
</span><span class='line'>  ["b" 
</span><span class='line'>    [[
</span><span class='line'>      [[input 2 =] [cur-stack [0 b]   against-stack] i] 
</span><span class='line'>      [[input 1 =] [cur-stack [pop a] against-stack] i]
</span><span class='line'>    ] condn]] 
</span><span class='line'>  ["a" 
</span><span class='line'>    [[
</span><span class='line'>      [[input 2 =] [cur-stack [pop b] against-stack] i] 
</span><span class='line'>      [[input 1 =] [cur-stack [0 b]   against-stack] i]
</span><span class='line'>    ] condn]]
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<p>We can see a strong semblance to the sort of code we were writing to explicitly define a state machine. There are a couple of things to note here. First, we don&rsquo;t have any top-level definitions for the states, everything is contained in a single list. This means that the <code>a</code> and <code>b</code> references in the code don&rsquo;t have any actual meaning, so we are yet to obtain properly executable code. The second thing to note is what happened to the code inside the cells. Each piece of code got placed in its appropriate execution branch wrapped around in some mysterious incantations. This warrants a closer look.</p>

<p>The last problem that we had with manually constructing state machines is the lack of transparency when dealing with the stack; each function required special wrapping to be run against the stack. The <code>against-stack</code> function takes care of this problem. It uses the <code>infra</code> combinator (see <a href="http://www.kevinalbrecht.com/code/joy-mirror/html-manual.html">manual</a>) to run our code against the list we are currently using as our stack. So the code we are executing can treat our artificial stack as a regular Joy stack, hence no special wrapping for the functions that we use in the cells is required. In essence, we&rsquo;ve managed to embed Joy itself back into our embedded DSL; that&rsquo;s kind of mind-bendy. When execution is done, <code>against-stack</code> takes the result and splits out the next state from the rest of the stack, producing both a new state and a new stack.</p>

<p>The line <code>[cur-stack [0 b] against-stack] i</code> can be read as &ldquo;take the current value of the stack, the code <code>0 b</code> and run the code against the stack&rdquo;; the <code>i</code> actually forces this code to be executed when we reach the branch.</p>

<p>To make our list executable, we need to somehow take care of the undefined state references. The first guess would be to just expand each reference with its explicit form as it is presented in the code above. The problem with this approach is that the states are mutually recursive. So the replacement process will go into an infinite loop. We didn&rsquo;t have this problem when manually defining the states, because we used top-level definitions, which can be mutually recursive. But that&rsquo;s not possible in this case, as we can&rsquo;t dynamically add top-level definitions. What we need to do is to somehow delay the evaluation of these references until they are actually needed.</p>

<p>For this purpose, we are going to introduce an execution environment. The environment will contain a map where every entry is a state name with an unexpanded definition of that state, and so every reference to a state can be replaced by a call into the map, fetching the right state. For this to actually work, we first need to do this replacement, yielding:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[
</span><span class='line'>  ["b" 
</span><span class='line'>    [[
</span><span class='line'>      [[input 2 =] [cur-stack [0 "b" states-map swap find-in-map]   against-stack] i] 
</span><span class='line'>      [[input 1 =] [cur-stack [pop "a" states-map swap find-in-map] against-stack] i]
</span><span class='line'>    ] condn]] 
</span><span class='line'>  ["a" 
</span><span class='line'>    [[
</span><span class='line'>      [[input 2 =] [cur-stack [pop "b" states-map swap find-in-map] against-stack] i] 
</span><span class='line'>      [[input 1 =] [cur-stack [0 "b" states-map swap find-in-map]   against-stack] i]
</span><span class='line'>    ] condn]]
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<p>The line <code>"b" states-map swap find-in-map</code> replaced the state <code>b</code>, which is just a fancy way of saying &ldquo;look for the name <code>"b"</code> in the <code>states-map</code> variable&rdquo;. The <code>states-map</code> variable will be our environment when we execute the state machine, containing the states as they are presented above for its entries.</p>

<p>To run our state machine, we&rsquo;ll write a function called <code>run-state-from-stack-with-env</code>, similar to the <code>run-state-from-stack</code> we defined before. The main difference is that we now have an additional argument for our environment. To achieve the use of the environment when actually executing the state transition function, we use the <code>splice-from-map</code> function that we developed in the <a href="http://ncreep.github.io/language_perils/blog/2013-05-24-meta-joy.html">metaprogramming</a> post. It performs the appropriate &ldquo;find and replace&rdquo; every time we stumble upon a <code>states-map</code> reference.</p>

<p>That, essentially, concludes everything we need to define and run our state machines. But there&rsquo;s a minor wrinkle about the process as described above, and that&rsquo;s that in the current scheme of finding and replacing state references we may miss any such references that are hidden in other function definitions. For example, if our state machine was:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func == pop a
</span><span class='line'>
</span><span class='line'>    @      1   |     2   |
</span><span class='line'>[a] : [  0  b ]|[ pop b ]|
</span><span class='line'>[b] : [  func ]|[  0  b ]|</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;d miss the <code>a</code> reference hidden inside <code>func</code>. To avoid this issue, when constructing the state machine code, we also recursively expand any user-defined symbols with the <code>expand-user-syms</code> function. This way, all state references are exposed when we do the &ldquo;find and replace&rdquo; routine described above.</p>

<p>Okay, now we are ready to rewrite the baby state machine (the full code is in <a href="https://github.com/ncreep/language_perils/blob/master/Joy/state_machine/baby_state_machine_dsl.joy">baby_state_machine_dsl.joy</a>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># incrementing/decrementing the number of parent mistakes
</span><span class='line'>wrong == succ
</span><span class='line'>right == pred
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># the baby decides whether it needs to call a social worker
</span><span class='line'>should-call-sw == [max-mistakes &gt;=] [call-sw] [wrong crying] ifte
</span><span class='line'>
</span><span class='line'># 'call-sw' stands for "call social worker"
</span><span class='line'>
</span><span class='line'>baby == 
</span><span class='line'>          @   "sing-lullaby"   |      "feed"      |    "soothe"    |
</span><span class='line'> [sleepy] : [  right asleep   ]|[  wrong crying  ]|[ wrong crying ]|
</span><span class='line'> [hungry] : [  wrong crying   ]|[  right asleep  ]|[ wrong crying ]|
</span><span class='line'> [asleep] : [  wrong crying   ]|[  wrong crying  ]|[ wrong crying ]|
</span><span class='line'> [crying] : [ should-call-sw  ]|[ should-call-sw ]|[ right asleep ]|
</span><span class='line'>[call-sw] : [    call-sw      ]|[    call-sw     ]|[   call-sw    ]|</span></code></pre></td></tr></table></div></figure>


<p>Apart from being transposed, this closely follows the table definition of the table state machine, so we don&rsquo;t have the redundancies in the description that we had in the explicit version. As you can see, the stack manipulation functions do not require any special wrapping. Hence we&rsquo;ve covered all of our pain points from before.</p>

<p>Because DSLs are all about their visual flare, we can add a bit of garnish to this definition. We define the following no-ops, which can be used as delimiters:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>, == id
</span><span class='line'>? == id</span></code></pre></td></tr></table></div></figure>


<p>This yields our final version of the state machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>baby == 
</span><span class='line'>          @    "sing-lullaby"   |       "feed"      |    "soothe"     |
</span><span class='line'> [sleepy] : [  right, asleep   ]|[  wrong, crying  ]|[ wrong, crying ]|
</span><span class='line'> [hungry] : [  wrong, crying   ]|[  right, asleep  ]|[ wrong, crying ]|
</span><span class='line'> [asleep] : [  wrong, crying   ]|[  wrong, crying  ]|[ wrong, crying ]|
</span><span class='line'> [crying] : [ should-call-sw?  ]|[ should-call-sw? ]|[ right, asleep ]|
</span><span class='line'>[call-sw] : [    call-sw       ]|[     call-sw     ]|[    call-sw    ]|</span></code></pre></td></tr></table></div></figure>


<p>Which I find to be slightly more visually pleasing.</p>

<p>We can run the state machine as before:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>["soothe"] [sleepy] run-baby-table # =&gt; [crying]
</span><span class='line'>["soothe" "feed" "sing-lullaby" "feed"] [sleepy] run-baby-table # =&gt; [call-sw]</span></code></pre></td></tr></table></div></figure>


<p>I think this can be declared a success, and with an elated feeling of self-satisfaction we can call it quits now.</p>

<p>This concludes our excursion into the world of DSLs. As we experienced firsthand, developing a DSL is a lot like developing a real language. We have the actual syntax, we &ldquo;compile&rdquo; it into an intermediate representation, then &ldquo;compile&rdquo; it further down into executable code. And we even ran it with a non-trivial environment. If that&rsquo;s not your definition of &ldquo;fun&rdquo;, I don&rsquo;t know what is.</p>

<p>Using Joy for this purpose made the experience very lightweight, the whole definition of the DSL is about 100 lines of code. Minimal syntax and the corresponding homoiconicity make a language very amenable to embedding DSLs into it. I think our little exercise definitely demonstrates this point.</p>

<p>This also concludes my excursion into Joy, in the <a href="http://ncreep.github.io/language_perils/blog/2014-03-24-joy-no-more.html">next post</a>, I&rsquo;ll sum up the experience.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[State of Joy]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2014-03-19-state-of-joy.html"/>
    <updated>2014-03-19T01:54:19+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/state-of-joy</id>
    <content type="html"><![CDATA[<p>Having finished with <a href="http://ncreep.github.io/language_perils/blog/2013-04-21-joyous-tree-friends.html">binary trees</a> and getting somewhat sidetracked by <a href="http://ncreep.github.io/language_perils/blog/2013-05-24-meta-joy.html">metaprogramming</a>, we are now ready for our next small project. Implementing binary trees was sort of a warm-up for getting used to Joy &ndash; now I would like to do something a bit less textbooky.</p>

<p>As you may recall, Joy has a very flexible syntax due to its homoiconicity (as can be seen in the metaprogramming post). Having a flexible syntax should make a language easily amenable to embedding of <a href="http://en.wikipedia.org/wiki/Domain-specific_language">domain-specific languages</a> (DSLs). Personally, I&rsquo;m a big fan of DSLs, so trying to implement one in Joy seems like a nice idea for a small project.</p>

<p>In order to actually have a domain-specific language, we first need to come up with a domain. Having gone through a careful process of examining and comparing various domains (i.e., choosing the first thing that randomly came up in my mind at some distant point in time), I decided to model <a href="http://en.wikipedia.org/wiki/State_machine">state machines</a>. More specifically, I&rsquo;ll be implementing a small language that can describe state machines augmented by a stack, which makes it a <a href="http://en.wikipedia.org/wiki/Pushdown_automaton">pushdown automaton</a>. Adding a stack to our machine seems like a natural idea for a stack-based language and also makes the domain a tad more interesting; we&rsquo;ll see how that works out later on.</p>

<!-- more -->


<p>(For the more pedantically inclined, what we&rsquo;ll implement will actually have access to the whole stack and to the whole of Joy&rsquo;s stack-manipulation power, so strictly speaking it&rsquo;s going to be something more powerful than a pushdown automaton, but we won&rsquo;t linger on that point.)</p>

<p>Before we get to our state machine DSL, we&rsquo;ll write some code that can evaluate state machines, which will give us a better understanding of our domain; let us get to that.</p>

<p>A state machine is simply a list of states with their corresponding transition functions. The transition functions take the current input and, depending on its value and the current stack, decide what the next state is. In our implementation, a state will be a list pair, where the first item is the value of the state, e.g., its name, and the second is the state transition function. To make this more obvious in the code, we&rsquo;ll define their corresponding accessors:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>state-value == 0 at # fetch the state value
</span><span class='line'>next-state == 1 at # fetch the transition function</span></code></pre></td></tr></table></div></figure>


<p>(All code for this post can be found in <a href="https://github.com/ncreep/language_perils/tree/master/Joy/state_machine">this folder</a>, the main code for the state machine implementation is in <a href="https://github.com/ncreep/language_perils/blob/master/Joy/state_machine/state_machine.joy">state_machine.joy</a>)</p>

<p>The core part of our state machine evaluation process is this function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># runs a state against an input list: input state stack -&gt; final-state-value
</span><span class='line'>run-state-from-stack == 
</span><span class='line'>  swap # arguments are now: input stack state
</span><span class='line'>  [finish-state-run] [popd popd state-value] [
</span><span class='line'>    [move-first] dip
</span><span class='line'>    next-state i # input [stack value] -&gt; input new-stack new-state
</span><span class='line'>  ] tailrec;</span></code></pre></td></tr></table></div></figure>


<p>It takes a list of inputs, an initial state, and a stack (which is just a list that we&rsquo;ll treat as a stack). It then runs the state machine against the inputs while maintaining the stack in the background. The whole thing works by recursively evaluating the current transition function against the current input and stack; the recursion is made anonymous by using the <code>tailrec</code> combinator. Let&rsquo;s break down the definition:</p>

<ul>
<li>We swap the arguments to have them in the right order for our recursive step.</li>
<li>We check whether we are done (i.e., there&rsquo;s no more input) with the <code>finish-state-run</code> function.</li>
<li>If so, we throw out all our arguments and pick out the current state value.</li>
<li>Otherwise, we pair up our current input (the first item in the input list) and the current stack using the <code>move-first</code> function.</li>
<li>Using the <code>i</code> combinator, we evaluate the transition function against the input/stack pair.</li>
<li>The output of the transition function is the next state; at this point we recurse and start all over.</li>
</ul>


<p>And that&rsquo;s all we need to evaluate a state machine. To see that it actually works, let&rsquo;s code up a concrete state machine. Apart from actually demonstrating what we&rsquo;ve done thus far, this will also be helpful in the design of our DSL. It may so happen that what we already have is close enough to our domain, and we won&rsquo;t have a need for a special language. That being very unlikely, at the very least we may get some pointers to what aspects of our syntax we should optimize to get closer to the domain.</p>

<p><em>(cue the narrator)</em></p>

<blockquote><p>Family is important, and as programmers, we should strive to help other programmers deal with realistic scenarios that come up in family life. In this installment of our &ldquo;Family for Geeks&rdquo;, we&rsquo;ll see how to deal with babies.</p></blockquote>

<p><em>(fading out with happy jingle music)</em></p>

<p>So, we&rsquo;ll implement a state machine that totally realistically models the behavior of a typical baby. Our baby has a number of possible states: sleepy, hungry, asleep, and crying. Obviously, the last one is the most common. Our main goal is to choose the right action to get the baby to fall asleep. We have a number of actions that we can do with the baby; these are the inputs to the state machine: sing a lullaby, feed, and soothe. To make this more realistic, our baby is going to <del>be vindictive</del> have a memory. The baby is going to keep count for every time we mess up and choose a wrong action. Once we&rsquo;ve messed up too many times, the baby is going to call a social worker. Calling a social worker will be counted as yet another state of a baby. Here is our baby&rsquo;s behavior described by a table:</p>

<pre id="baby-table">
             || sleepy | hungry | asleep |          crying            | call social worker |
============================================================================================
sing lullaby || asleep | crying | crying | should call social worker? | call social worker |
        feed || crying | asleep | crying | should call social worker? | call social worker |
      soothe || crying | crying | crying |          asleep            | call social worker |
</pre>


<p>The header row contains the possible states of the baby; the first column has the possible actions. For every state/action pair, we choose the baby&rsquo;s next state. Getting the baby into the crying state is considered wrong, and we&rsquo;ll use the stack to keep track of the number of wrongs. If we get the baby into the asleep state, we get to decrement our wrongs count. Once the baby is in the crying state, we check whether the baby was wronged too many times (&ldquo;should call social worker?&rdquo;). If so, we move to the call social worker state (which is pretty much game over in this state machine). Otherwise, we keep on crying.</p>

<p>This sums up the behavior of a typical baby in a completely life-like fashion. Now, we can try and write it down as real code (which can be found in <a href="https://github.com/ncreep/language_perils/blob/master/Joy/state_machine/baby_state_machine.joy">baby_state_machine.joy</a>):</p>

<div id="baby-states">
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sleepy == ["sleepy" [[
</span><span class='line'>  [["sing-lullaby" input-is] right asleep]
</span><span class='line'>  [["feed" input-is] wrong crying]
</span><span class='line'>  [["soothe" input-is] wrong crying]
</span><span class='line'>] condn]];
</span><span class='line'>  
</span><span class='line'>hungry == ["hungry" [[
</span><span class='line'>  [["sing-lullaby" input-is] wrong crying]
</span><span class='line'>  [["feed" input-is] right asleep]
</span><span class='line'>  [["soothe" input-is] wrong crying]
</span><span class='line'>] condn]];
</span><span class='line'>  
</span><span class='line'>asleep == ["asleep" [[
</span><span class='line'>  [["sing-lullaby" input-is] wrong crying]
</span><span class='line'>  [["feed" input-is] wrong crying]
</span><span class='line'>  [["soothe" input-is] wrong crying]
</span><span class='line'>] condn]];
</span><span class='line'>  
</span><span class='line'>crying == ["crying" [[
</span><span class='line'>  [["sing-lullaby" input-is] should-call-social-worker]
</span><span class='line'>  [["feed" input-is] should-call-social-worker]
</span><span class='line'>  [["soothe" input-is] right asleep]
</span><span class='line'>] condn]];
</span><span class='line'>
</span><span class='line'>call-social-worker == ["call-social-worker" [cur-stack call-social-worker]];</span></code></pre></td></tr></table></div></figure>
</div>


<p>Well, that sucked&hellip; If you squint hard enough, you may recognize our state machine from before, but there&rsquo;s a whole lot of noise obscuring it from us.</p>

<p>As you can see, every state gets its own top-level definition. The first bit of the state is just its name as a string. Next comes the state transition function in the form of a conditional <code>condn</code>, which is just like the built-in <code>cond</code> (which acts like a multi-branch <code>if</code> expression) but does not require a default case. Every line corresponds to one possible input. The <code>input-is</code> function checks the current input against the string; if it matches, we execute the following code. Because our input is part of an input/stack pair, the <code>input-is</code> function has to break it down to fetch out the input from the pair and only then compare it to the input in the current branch.</p>

<p>The code that we execute after choosing a branch works against the input/stack pair and must produce a new stack value and a new state as a result. In most cases, we need to decide whether the action is wrong or right and increment/decrement the stack, then we choose the next state. For this purpose, we use one of either <code>wrong</code> or <code>right</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wrong == [succ] on-stack;
</span><span class='line'>right == [pred] on-stack;
</span><span class='line'>
</span><span class='line'># [stack value] func -&gt; new-stack
</span><span class='line'>on-stack  == swap cur-stack uncons [swap i] dip cons;</span></code></pre></td></tr></table></div></figure>


<p>The <code>on-stack</code> combinator takes a piece of code and executes it against the top value of the current stack. It takes care of splitting out the stack from the input/stack pair (using <code>cur-stack</code>) and applying a function to its top value. The <code>wrong</code> and <code>right</code> functions just pass the <code>succ</code> (increment) or <code>pred</code> (decrement) to the <code>on-stack</code> combinator to achieve the required effect.</p>

<p>For example, the line <code>[["feed" input-is] wrong crying]</code> checks whether the input is <code>feed</code>; if so, the action was wrong, and we increment the counter and move on to the <code>crying</code> state.</p>

<p>In the case where we need to check whether a social worker should be called, we invoke <code>should-call-social-worker</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>should-call-social-worker == 
</span><span class='line'>  [cur-stack first max-mistakes &gt;=] 
</span><span class='line'>  [cur-stack call-social-worker] 
</span><span class='line'>  [wrong crying] ifte</span></code></pre></td></tr></table></div></figure>


<p>This checks whether the counter on the top of the stack went past our mistake limit; if so, it leaves the stack as is (<code>cur-stack</code>) and chooses the <code>call-social-worker</code> state. Otherwise, we invoke the <code>wrong</code> function and stay in the <code>crying</code> state.</p>

<p>The <code>call-social-worker</code> state is trivial and just keeps the stack as is, without moving to another state.</p>

<p>We can now spot some patterns of repetitiveness that, hopefully, our DSL will be able to eradicate. Firstly, we are repeating our state names both as their definition name and their string name in the state value. Secondly, the list of possible inputs is repeated in almost all of the states. Lastly, manipulating the stack is rather explicit; every function we want to invoke on the stack has to be wrapped in an <code>on-stack</code> combinator, and even if we don&rsquo;t need anything on the stack at all, we still have to mention it with the <code>cur-stack</code> function. You&rsquo;d expect to be able to achieve something more transparent than that from a stack-based language.</p>

<p>All that aside, we can actually execute our state machine with the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>["soothe"] sleepy run-baby-state # =&gt; "crying"
</span><span class='line'>["soothe" "feed" "sing-lullaby" "feed"] sleepy run-baby-state # =&gt; "call-social-worker"</span></code></pre></td></tr></table></div></figure>


<p>The first argument is the input list, the second is the state we start from.<br/>
So at least it works as expected.</p>

<p>This concludes the exposition of the domain, in the next <a href="http://ncreep.github.io/language_perils/blog/2014-03-20-domain-specific-joy.html">installment</a> we&rsquo;ll try to come up with an actual language specific to it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Meta-Joy]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2013-05-24-meta-joy.html"/>
    <updated>2013-05-24T14:34:00+03:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/meta-joy</id>
    <content type="html"><![CDATA[<p>In the <a href="http://ncreep.github.io/language_perils/blog/2013-04-21-joyous-tree-friends.html">previous post</a> I was struggling with the noise generated in my code by stack manipulation-related functions. Having reached a dead end, I promised you a shiny new direction, which I&rsquo;ll be introducing in this post.</p>

<p>To do that, we&rsquo;ll have to recap one of the Joy basics, namely, its homoiconicity. In the <a href="http://ncreep.github.io/language_perils/blog/2013-03-18-the-joy-of-joy.html">introduction</a>, I mentioned how Joy&rsquo;s list primitive is actually a quoted program; this should be familiar if you&rsquo;re acquainted with Lisp lists. So&hellip; we can easily go meta on the language by employing list manipulation. Here&rsquo;s a simple example to illustrate the point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1 2] [+] concat i # =&gt; 3</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>(<code>i</code> evaluates the list as a program)</p>

<p>As a real program may be an arbitrarily nested list, manipulating it won&rsquo;t be that simple. Say I want to turn this piece of code <code>[1 [2 3 +] *]</code> into <code>[1 [2 3 *] *]</code>. I can do this manually like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1 [2 3 +] *] dup
</span><span class='line'>1 at         # =&gt; [2 3 +]
</span><span class='line'>2 take       # =&gt; [2 3]
</span><span class='line'>[*] concat   # =&gt; [2 3 *]
</span><span class='line'>1 insert-at. # =&gt; [1 [2 3 *] *]</span></code></pre></td></tr></table></div></figure>


<p>(which assumes the availability of the <code>insert-at</code> function we were messing about with the last time)</p>

<p>And obviously, this approach is too clumsy to scale up to any real use case. What we need is some generic way to find and replace bits of lists with other bits. To do this, I&rsquo;ll introduce yet another step in the meta direction. In the standard library, we have the <code>name</code> function, which takes a symbol, e.g. a non-literal item in a list, and returns its name as a string, like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[foo bar baz] [name] map # =&gt; ["foo" "bar" "baz"]</span></code></pre></td></tr></table></div></figure>


<p>Armed with this function, we can treat quoted programs as lists of strings, and do any sort of string manipulation we may want with it (we also have the inverse of <code>name</code> &ndash; <code>intern</code>, which takes a string and returns a symbol). And how is this useful in our quest for list manipulation nirvana? It means that we can treat finding and replacing of program parts as finding and replacing (splicing) strings in a list, and that&rsquo;s a rather down-to-earth non-meta operation.</p>

<p>Inspired by Lisp macros, I decided to implement a splicing scheme illustrated by this example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>["two" "four" "five"] [[1 ~0 3] [~1 ~2] concat] splice-from-list # =&gt; [[1 "two" 3] ["four" "five"] concat]</span></code></pre></td></tr></table></div></figure>


<p>The first list is the argument list and the second is the target program skeleton. Each <code>~X</code> symbol is treated as an index <code>X</code> in the argument list. Upon application of the <code>splice-from-list</code> function, each occurrence of the <code>~X</code> pattern is replaced by the corresponding item in the argument list.</p>

<p>The code for the implementation is in the <a href="https://github.com/ncreep/language_perils">repository</a> in the <a href="https://github.com/ncreep/language_perils/blob/master/Joy/meta_joy/meta.joy">meta.joy</a> file; let&rsquo;s look at it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>splice-from-list == [ 
</span><span class='line'>  [is-num-splice-pattern] 
</span><span class='line'>  [splice-to-num at] 
</span><span class='line'>  []
</span><span class='line'>  ifte
</span><span class='line'>] treemap popd;</span></code></pre></td></tr></table></div></figure>


<p>The function <code>treemap</code> does most of the heavy lifting. <code>treemap</code> takes a tree (which is an arbitrarily nested list where each non-list value is treated as a leaf) and applies a given function to each leaf; it is rather simple to implement using the built-in <code>treerec</code> combinator. In our case, the tree is the program skeleton, its symbols are the leaves and the function to be applied is the <code>ifte</code>  expression. The <code>ifte</code>  expression checks whether a symbol matches the splicing pattern (<code>is-num-splice-pattern</code>). If it does, the <code>ifte</code>  expression converts it to a number (<code>splice-to-num</code>) and fetches the corresponding list item, otherwise, it leaves it as is. It&rsquo;s in the <code>is-num-splice-pattern</code> and <code>splice-to-num</code> functions that we apply our ability to treat symbols as text.</p>

<p>It is important to note that the <code>~X</code> patterns don&rsquo;t have any special significance in Joy; they are just valid identifiers. Trying to evaluate a piece of code that contains them without any replacement will probably result in an error, as they won&rsquo;t have any predefined meaning.</p>

<p>Because we are after a more convenient way to write functions, a more likely scenario is to splice values directly from the stack, so we have</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>splice-from-stack ==  swap [take-from-stack] dip splice-from-list;</span></code></pre></td></tr></table></div></figure>


<p>where <code>take-from-stack</code> takes a fixed number of items from the stack and places them in a list. Now we can write</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"two" "four" "five" [[1 ~0 3] [~1 ~2] concat] 3 splice-from-stack # =&gt; [[1 "two" 3] ["four" "five"] concat]</span></code></pre></td></tr></table></div></figure>


<p>Note how the <code>"two" "four" "five"</code> items are on the stack and not in a list. In most cases, it may feel redundant to write the number of items to take from the stack, it is evident from the maximal value of <code>X</code> in the different <code>~X</code> patterns, so we define</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>splice-from-stack-max == [max-splice-num 1 +] nullary splice-from-stack;</span></code></pre></td></tr></table></div></figure>


<p>And the final product:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>splice == splice-from-stack-max i;</span></code></pre></td></tr></table></div></figure>


<p>which actually evaluates the resulting program, as in</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"two" "four" "five" [[1 ~0 3] [~1 ~2] concat] splice # =&gt; [1 "two" 3 "four" "five"]</span></code></pre></td></tr></table></div></figure>


<p>Now we are ready for a first attempt at rewriting the <code>insert-at</code> function from the <a href="http://ncreep.github.io/language_perils/blog/2013-04-21-joyous-tree-friends.html">previous post</a> using our cool new metaprogramming techniques. First, let&rsquo;s recall the original function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># inserts an item at a given position, deleting the previous item: list val index -&gt; list
</span><span class='line'>insert-at == 
</span><span class='line'>  swapd dupd dup swapd
</span><span class='line'>  take rollup
</span><span class='line'>  1 + drop
</span><span class='line'>  enconcat;</span></code></pre></td></tr></table></div></figure>


<p>And here&rsquo;s the new version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert-at == [
</span><span class='line'>  ~1
</span><span class='line'>  ~0 ~2 take
</span><span class='line'>  ~0 ~2 1 + drop
</span><span class='line'>  enconcat
</span><span class='line'>] splice;</span></code></pre></td></tr></table></div></figure>


<p>Success! We have no stack primitives visible in the code. But&hellip; I&rsquo;m not quite satisfied with the fact that the function arguments don&rsquo;t have explicit names. You see, I have this issue, I like naming things: variables, functions, babies, you name it. I mean, I name it, that is, I will name it once you give me the thing. As Joy is devoid of either variables or babies, the only thing left to name is functions, and the only way to do this is to include them in a top level <code>DEFINE</code>, so we can&rsquo;t have function-local definitions (something along the lines of Lisp&rsquo;s <code>let</code> definitions).</p>

<p>Splicing to the rescue. Instead of splicing from a list (or the stack), we can do the splicing from a map, like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[four "four"] [two "two"] [five "f" "ive" concat]] 
</span><span class='line'>[four  [1 two 3] [five 6 7] enconcat]
</span><span class='line'>splice-from-map # =&gt; [1 "two" 3 "four" "f" "ive" concat 6 7]</span></code></pre></td></tr></table></div></figure>


<p>The first nested list is treated as a map where each entry is another list. In each entry, the first symbol is treated as a key and the rest as the value. The second list is the program skeleton, where we replace every occurrence of a symbol that appears in the map with the value it is mapped to. The corresponding implementation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>splice-from-map == [ 
</span><span class='line'>  [key-in-map] 
</span><span class='line'>  [find-by-key] 
</span><span class='line'>  []
</span><span class='line'>  ifte
</span><span class='line'>] treemap-concat popd i;</span></code></pre></td></tr></table></div></figure>


<p>which is quite similar to <code>splice-from-list</code>. Instead of looking for <code>~X</code> patterns, we look for items that appear in our map. Instead of fetching from a list, we fetch from a map. The last difference is that instead of mapping with <code>treemap</code> we use <code>treemap-concat</code>, which maps a function that takes a leaf and results in a list merged into the tree instead of the original leaf. The reason we need that is to be able to use multiple symbols as values in the map (like <code>"f" "ive" concat</code> in the example). The implementation of <code>treemap-concat</code> was a bit tricky to get right at 4 a.m., I&rsquo;ll leave the figuring out how it works as an exercise.</p>

<p>To slightly simplify the usage of <code>splice-from-map</code>, we&rsquo;ll allow to join the map and program skeleton into a single list, as in:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[[plus +] 
</span><span class='line'>  [square dup *]] 
</span><span class='line'>  3 2 plus square       
</span><span class='line'> ] let-map # =&gt; 25</span></code></pre></td></tr></table></div></figure>


<p>The definition of <code>let-map</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let-map ==  [first] [rest] cleave splice-from-map;</span></code></pre></td></tr></table></div></figure>


<p>And now we have a simple implementation of local definitions. To make this more usable in the context of naming function arguments, we&rsquo;ll compose this with stack splicing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let == splice-from-stack-max let-map;</span></code></pre></td></tr></table></div></figure>


<p>Using <code>let</code> we can rewrite the <code>insert-at</code> function as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert-at == [
</span><span class='line'>    [[list ~0] [val ~1] [index ~2]]
</span><span class='line'>      val
</span><span class='line'>      list index take
</span><span class='line'>      list index 1 + drop
</span><span class='line'>      enconcat
</span><span class='line'>] let;</span></code></pre></td></tr></table></div></figure>


<p>The combination of list and map splicing acts somewhat like named arguments in regular languages. It is definitely more explicit than the previous version, but I find it a bit clumsy to write. In simple cases where we only need items from the stack without any transformations, we can use this function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let-splice == [first list-to-splice] [rest] cleave cons let;</span></code></pre></td></tr></table></div></figure>


<p>Instead of taking a map like <code>let</code>, it takes a list of symbols and converts the list into a map where the symbols are the keywords and consecutive <code>~X</code> patterns are the values (<code>list-to-splice</code>). With this, we arrive at our final version of <code>insert-at</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert-at == [
</span><span class='line'>    [list val index]
</span><span class='line'>      val
</span><span class='line'>      list index take
</span><span class='line'>      list index 1 + drop
</span><span class='line'>      enconcat
</span><span class='line'>] let-splice;</span></code></pre></td></tr></table></div></figure>


<p>The first line of the definition declares the arguments, saying: &ldquo;I&rsquo;ll need three arguments from the stack, and I&rsquo;ll be using these names for them&rdquo;. <code>let-splice</code> does the magic of figuring out the mapping between the arguments and the values on the stack. This syntax is less flexible than <code>let</code>, as we can only name values from the stack and not any other expression. But I think it works well in this example, yielding the most readable code thus far.</p>

<p>As you may remember, but probably don&rsquo;t, this whole quest for stack manipulation cleansing started out with my wish to write a readable version of the <code>build-tree-with-value</code> function, which traverses a tree looking for a value and uses a pair of functions to handle success or failure. In pseudocode it looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build-tree-with-value == [
</span><span class='line'>    [ [empty-tree] [empty-handler] ]
</span><span class='line'>    [ [value =] [value-handler] ]
</span><span class='line'>    
</span><span class='line'>    [ [value &lt;] [set-left-tree-for-recursion] [insert-new-left-tree] ]
</span><span class='line'>    [           [set-right-tree-for-recursion] [insert-new-right-tree] ]
</span><span class='line'>] condlinrec</span></code></pre></td></tr></table></div></figure>


<p>And to remind you of the atrocity you had to go through last time, heeere&rsquo;s Johnny:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build-tree-with-value == rollup swap [
</span><span class='line'>  [ [empty-tree] [rolldown dup 0 at rollupd i] ]
</span><span class='line'>  [ [value =] [rolldown dup 1 at rollupd i] ]
</span><span class='line'>      
</span><span class='line'>  [ [value &lt;] [dup left-tree rollupd] [swapd insert-left] ]
</span><span class='line'>  [           [dup right-tree rollupd] [swapd insert-right] ]
</span><span class='line'>] condlinrec popd</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>You can open your eyes now, I won&rsquo;t be doing that again. Can our new meta-power-tools help us alleviate the pain? It so happens that yes, they definitely can. Here&rsquo;s Johnny reformed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build-tree-with-value == [ 
</span><span class='line'>  [val empty-handler val-handler] [
</span><span class='line'>      [ [empty-tree]  [val empty-handler i] ]
</span><span class='line'>      [ [value val =] [val val-handler i] ]
</span><span class='line'>      
</span><span class='line'>      [ [value val &gt;] [_left-tree] [insert-left] ]
</span><span class='line'>      [               [_right-tree] [insert-right] ]
</span><span class='line'>] condlinrec] let-splice;</span></code></pre></td></tr></table></div></figure>


<p>The original algorithm was slightly modified to make this more readable. Namely, the value being searched for is not passed around &ndash; it is wired into the skeleton of the code; this affects the signature of the handler functions, which is now <code>tree value -&gt; tree</code>. It also inverts the comparison sign in the last predicate. The full new implementation can be found <a href="https://github.com/ncreep/language_perils/blob/master/Joy/bin_tree/Trees2.joy">here</a>.</p>

<p>I actually wasn&rsquo;t expecting that much similarity to the pseudocode, I wrote it long before I had a readable version of <code>build-tree-with-value</code>. And what&rsquo;s more important is that we are using a generic solution, not something tailor-made for this particular problem. Another thing I quite like about this solution is how natural it was to build it in incremental steps: write a function, compose it with another one to refine it, rinse and repeat. That&rsquo;s a general property of Joy (and probably any other concatenative language), making it easy to write simple, bite-size pieces of code.</p>

<p>Now, one might expect me to go OCD on the rest of my binary tree implementation, and prune out as much of the remaining stack manipulation bits as possible, but I won&rsquo;t be doing that. No, seriously, not going to bother, I&rsquo;m totally fine with how it is&hellip;</p>

<p>There are some reservations about my meta solution, though. First off, the implementation is far from being complete. The <code>let</code>/<code>splice</code> expressions cannot be properly nested in all cases, e.g.:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[[a 2]] [[[a 3]] a 4 *] let] let # =&gt; 9
</span><span class='line'>[[[a dup dup]] [[[a pop]] 4 a] let] let # =&gt; 4</span></code></pre></td></tr></table></div></figure>


<p>And you can&rsquo;t make a definition and use it in the same map, so this is not valid:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[[a dup] [b a pop]] 4 b] let</span></code></pre></td></tr></table></div></figure>


<p>Bearing in mind that the whole implementation is ~70 LOC (no, that&rsquo;s not a leftover splicing pattern, and no, I&rsquo;m not using a Joy-based templating engine), that&rsquo;s probably not so bad. Fixing these issues shouldn&rsquo;t be too complicated, but what we have should suffice as a proof of concept.</p>

<p>A completely different issue is performance related, though performance is of little significance to me in this case; it seems that using this kind of meta-programming really stresses out the GC. Running the new tree implementation on the usual Joy interpreter (the one you&rsquo;re likely to compile if you&rsquo;re fetching it from the <a href="http://www.kevinalbrecht.com/code/joy-mirror/joy.html">Joy site</a>, it has &ldquo;NOBDW&rdquo; in its title) crashes when trying to insert around 4 items. To circumvent the problem, I used the Joy interpreter compiled with the BDW GC (there&rsquo;s a special <code>make</code> file for that purpose). This fixes the issue, and you can easily insert more than 100 items in either implementation, though the meta-programming implementation is still considerably slower.</p>

<p>But the most important issue, in my opinion, is that it feels as if I&rsquo;m trying to shoehorn my approach to programming into Joy&rsquo;s. In this whole exercise, I&rsquo;m essentially trying to emulate named function arguments, which is one of the things that Joy seems to purposefully avoid. My feeling is that there must exist somewhere &ldquo;The Joy Way &trade;&rdquo;, which would allow me to achieve the same level of readability without resorting to metaprogramming tricks. On the other hand, the fact that it was that simple to achieve this goal might be an indicator that maybe this approach was not an act of complete heresy. Any insight on this issue will be greatly appreciated.</p>

<p>Anyways, this concludes our excursion into the green lands of meta-trees. Stay tuned for the next time.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Joyous Tree Friends]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2013-04-21-joyous-tree-friends.html"/>
    <updated>2013-04-21T18:15:00+03:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/joyous-tree-friends</id>
    <content type="html"><![CDATA[<p>Having introduced Joy in the <a href="http://ncreep.github.io/language_perils/blog/2013-03-18-the-joy-of-joy.html">previous post</a>, as per our <a href="http://ncreep.github.io/language_perils/blog/2013-03-18-introduction.html">grand scheme of things</a>, we are now ready for some coding.</p>

<p>As a first small project, I decided to try and implement a simple <a href="http://en.wikipedia.org/wiki/Binary_search_tree">binary search tree</a>. Nothing fancy, no self-balancing or anything <a href="http://j.rigelseven.com/read/67201/">evil like that</a>. Just your Plain Old Binary Search Tree (which can be handily abbreviated as POBST).</p>

<p>The reason for this boring textbook example is twofold. First, Joy being, for me, a rather new way of thinking about code, I didn&rsquo;t want to distract myself with something overly creative. Having a ready recipe for the thing I want to code provides me with a nice distraction-free, Joyful coding experience. Second, as Joy stresses function-level programming (no values and all that), I was wondering how a data structure, which I think of as a value, would look like in this paradigm.</p>

<!-- more -->


<p>(Source code for this post is in the <a href="https://github.com/ncreep/language_perils/blob/master/Joy/bin_tree/Trees.joy">repository</a>).</p>

<p>First thing first, we need to have some representation of our tree. Now, we are quite far from our cozy OO land, mind you; we don&rsquo;t even have simple structs in Joy. So this is your typical &ldquo;we&rsquo;re not in Kansas anymore&rdquo; situation.<br/>
The omnipresent lists to the rescue. As we remember (or not), lists in Joy are heterogeneous, so we can stuff anything in them, including other lists, which fits well with the recursive nature of trees.</p>

<p>So for our tree, we&rsquo;ll use a list with three elements &ndash; the first is the value, the second is the left subtree, and the third is the right subtree. All parts are optional. A couple of examples:</p>

<p>An empty tree</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[]</span></code></pre></td></tr></table></div></figure>


<p>A tree with a single node</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[8 [] []]</span></code></pre></td></tr></table></div></figure>


<p>And this tree</p>

<p><img class="center" src="http://ncreep.github.io/language_perils/images/joy/simple_tree.png"></p>

<p>is</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[8 [2 [1 [] []] [5 [] []]] [10 [] [12 [] []]]]</span></code></pre></td></tr></table></div></figure>


<p>Untangled all the brackets? Great, we can move on.</p>

<p>In view of how simple the tree representation is, the second reason for implementing binary trees kind of evaporates, oh well&hellip;</p>

<p>The <a href="https://github.com/ncreep/language_perils/blob/master/Joy/bin_tree/Trees.joy">full source code</a> should be documented enough to be, in most parts, fairly readable; so I won&rsquo;t be explaining it step by step here. The final result is rather boring, e.g., we can create and query a tree like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>new-tree [4 8 6 1 3 6 4 3 4 9] add-all 3 tree-contains # =&gt; true</span></code></pre></td></tr></table></div></figure>


<p>(Note that, due to what I think is a bug in the interpreter, when adding a large number of items at a time, say 100, sometimes the interpreter either crashes or gives unexpected errors.)</p>

<p>No surprises here. But there are some interesting implementation details that are actually worth a discussion; we are getting to them below.</p>

<p>Having implemented getters (in a moment, we&rsquo;ll see <code>value</code>, which extracts the value of a tree node), setters (as our trees are immutable, setters, or any mutating operations, actually produce new trees) and some predicates for the tree parts, I am getting to the interesting bits: adding and removing elements from the tree.</p>

<p>Adding an item to the tree is a simple recursive operation: traverse the tree till you find the right place, insert a new node with the value there. In case the item is already present, do nothing. Joy being Joy, we have a combinator that makes this possible without writing an explicitly recursive function. In this case, we use <code>condlinrec</code> (see <a href="http://www.kevinalbrecht.com/code/joy-mirror/html-manual.html">manual</a>), which performs linear recursion, but unlike <code>linrec</code> it can check for multiple conditions before the recursion step or stopping.</p>

<p>A skeleton for the adding function looks like something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>add-val == [
</span><span class='line'>    [ [empty-tree] [create-new-tree-with-the-value] ]
</span><span class='line'>    [ [value =] [do-nothing] ]
</span><span class='line'>    
</span><span class='line'>    [ [value &lt;] [set-left-tree-for-recursion] [insert-new-left-tree] ]
</span><span class='line'>    [ [set-right-tree-for-recursion] [insert-new-right-tree] ]
</span><span class='line'>] condlinrec</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s not that difficult to fill in the pseudocode bits, but we won&rsquo;t be doing that; instead, let&rsquo;s see what the deleting function should look like. In pseudocode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>delete-val == [
</span><span class='line'>    [ [empty-tree] [do-nothing] ]
</span><span class='line'>    [ [value =] [create-a-new-tree-without-the-value] ]
</span><span class='line'>    
</span><span class='line'>    [ [value &lt;] [set-left-tree-for-recursion] [insert-new-left-tree] ]
</span><span class='line'>    [ [set-right-tree-for-recursion] [insert-new-right-tree] ]
</span><span class='line'>] condlinrec</span></code></pre></td></tr></table></div></figure>


<p>Hmm, rather similar, in both cases we are rebuilding the tree according to some value; the differences occur when we actually get to the value or when it&rsquo;s missing. Being conscientious programmers, we cannot let this code duplication be. The code must be WET (which is like DRY, but more suitable for trees), and we must find a way to hydrate it.</p>

<p>Simple enough, this is a functional language; we can pass the appropriate handler functions as parameters and let them take care of the differences, while keeping common code intact:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build-tree-with-value == [
</span><span class='line'>    [ [empty-tree] [empty-handler] ]
</span><span class='line'>    [ [value =] [value-handler] ]
</span><span class='line'>    
</span><span class='line'>    [ [value &lt;] [set-left-tree-for-recursion] [insert-new-left-tree] ]
</span><span class='line'>    [ [set-right-tree-for-recursion] [insert-new-right-tree] ]
</span><span class='line'>] condlinrec
</span><span class='line'>
</span><span class='line'>add-val == [[do-nothing] [create-new-tree-with-the-value]] build-tree-with-value
</span><span class='line'>delete-val == [[create-a-new-tree-without-the-value] [do-nothing]] build-tree-with-value</span></code></pre></td></tr></table></div></figure>


<p>Great, we got ourselves WET with Joy, done; we can now move on to greener pastures.<br/>
Well, of course not, that was just pseudocode, we actually need an implementation for this thing. And here it is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build-tree-with-value == rollup swap [
</span><span class='line'>  [ [empty-tree] [rolldown dup 0 at rollupd i] ]
</span><span class='line'>  [ [value =] [rolldown dup 1 at rollupd i] ]
</span><span class='line'>      
</span><span class='line'>  [ [value &lt;] [dup left-tree rollupd] [swapd insert-left] ]
</span><span class='line'>  [ [dup right-tree rollupd] [swapd insert-right] ]
</span><span class='line'>] condlinrec popd
</span><span class='line'>
</span><span class='line'>add-val == [[pop [[] []] cons] [popd]] build-tree-with-value
</span><span class='line'>delete-val == [[popd] [popd delete-tree]] build-tree-with-value</span></code></pre></td></tr></table></div></figure>


<p>Bugger me &ndash; I can&rsquo;t quite read this, and I wrote that not that long ago.<br/>
So why is it so complicated? In the pseudocode above, I elided any references to argument handling; I just assumed the arguments to be there when needed. That&rsquo;s quite natural for someone coming from a background of <a href="http://en.wikipedia.org/wiki/Value-level_programming">value-level</a> programming languages. When you write a function, e.g., in Java, arguments to functions are just there, available, without any fuss, by their name. Not so when you&rsquo;re dealing with a stack-based language; here, the arguments are implied to be on the stack, and they have no names. To be able to use them, you have to make sure that they are properly ordered on the top of the stack.</p>

<p>Back to our code. First, we have the easy bits; <code>add-val</code> and <code>delete-val</code> are actually quite similar to our pseudocode. They assume that a tree and a value to be added/removed are on top of the stack, each of them pushes their pair of handling functions onto the top of the stack, and passes control to <code>build-tree-with-value</code>.<br/>
The handler functions are rather simple; to figure them out, we need to remember that when we apply them we have the tree on the top of the stack and the value below it. After the application, we need to leave only the new tree and nothing else. I&rsquo;ll leave the figuring out as an exercise to the reader (oh how I hate when people do that. At last, the oh so sweet revenge&hellip;).</p>

<p>Now, <code>build-tree-with-value</code> creates a function that takes three arguments: a tree, a value, and a list with a pair of handler functions; in that order, i.e. the handler functions are on the top of the stack. But we don&rsquo;t want them that way, what we need is: handlers, value, tree. That&rsquo;s what the first <code>rollup swap</code> functions do. After applying them, we are ready for the recursion. And that&rsquo;s the last point where I can still explain the code without taking out a piece of paper and drawing many little stacks on it. As you can see, each condition is followed by a bunch of stack-manipulating functions, the whole purpose of which is to tweak the stack so that the arguments are in the right order, multiplicity and are ready for the further recursive calls. A horrid, horrid piece of code.</p>

<p>I would love to give the explanation of this code to you, the reader, as another exercise, but that would be just plain sadistic. And I won&rsquo;t be bothered to explain it myself, that would be way too tedious, boring and quite meaningless. Why meaningless? Because by now, I think that it&rsquo;s pretty clear that we are doing something wrong. To quote a <a href="http://www.codecommit.com/blog/cat/the-joy-of-concatenative-languages-part-1#comment-4407">comment</a> from the <a href="http://www.codecommit.com/blog/cat/the-joy-of-concatenative-languages-part-1">The Joy of Concatenative Languages</a> series</p>

<blockquote><p>If you find you need to be continually aware of the stack, then, plain and simple, &ldquo;You&rsquo;re Doing It Wrong.&rdquo;</p></blockquote>

<p>We need to step back and see how we can alleviate the stack manipulation problem. To do that, we&rsquo;ll examine a simpler case: the <code>insert-at</code> function. This function takes a list, a value and an index, and inserts the value at the specified position in the list. The algorithm we&rsquo;ll be implementing is:</p>

<ul>
<li>take the first N &ndash; 1 items from the list (prefix)</li>
<li>take the tail of list starting from the N + 1th item (tail)</li>
<li>concatenate the prefix value and tail.</li>
</ul>


<p>Simple enough, especially as we already have the <code>take</code>, <code>drop</code> and <code>enconcat</code> functions implemented for us. And here&rsquo;s my first naive attempt at an implementation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert-at == 
</span><span class='line'>  swapd dupd dup swapd
</span><span class='line'>  take rollup
</span><span class='line'>  1 + drop
</span><span class='line'>  enconcat;</span></code></pre></td></tr></table></div></figure>


<p>Not the horrors of <code>build-tree-with-value</code>, but still far from satisfactory; we cannot, by any means, plead ignorance of the stack.<br/>
For the sport of it, let&rsquo;s try to follow the definition.</p>

<ul>
<li>We start out with <code>list val index</code> (the rightmost item is the top of the stack).</li>
<li>The first line rearranges it, so that we have <code>val list index list index</code>.</li>
<li>The second line applies the <code>take</code> function to the top two items and pushes the result down the stack, so we have <code>val prefix list index</code>.</li>
<li>The third line calculates the tail of the list, leaving <code>val prefix tail</code>.</li>
<li>The last line performs the concatenation of all three items on the stack, and we are done.</li>
</ul>


<p>Now, our aim is to reduce the amount of stack related operations we see at each stage. To do this, I tried looking at the different functions and combinators available in Joy. But being a novice, I couldn&rsquo;t find anything simple that makes the code much better. What I managed to figure out is that part of the complexity stems from the fact that in order to reuse an argument, I have to duplicate it on the stack, which requires even more manipulation of the stack. One of the combinators that I found, <code>nullary</code>, allows to use a function without removing its arguments from the stack, so one can avoid the duplication in that case. Here&rsquo;s the best that I managed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert-at == 
</span><span class='line'>  swapd 
</span><span class='line'>  [take] nullary rollup
</span><span class='line'>  1 + drop
</span><span class='line'>  enconcat;</span></code></pre></td></tr></table></div></figure>


<p>The steps are as follows:</p>

<ul>
<li><code>list val index</code> &ndash;> <code>val list index</code></li>
<li><code>val list index</code> &ndash;> <code>val list index prefix</code> &ndash;> <code>val prefix list index</code></li>
<li><code>val prefix list index</code> &ndash;> <code>val prefix tail</code></li>
<li>Concatenating the last three items.</li>
</ul>


<p>A definite improvement, but I still don&rsquo;t see it as a satisfactory result. The second line seems rather cryptic to me. Further investigation in this direction did not yield anything better, so I decided to leave it at that.</p>

<p>If there are any Joy or concatenative gurus reading this, I would love to hear your opinion on how this code can be improved.</p>

<p>After abandoning this direction, I had another idea. I will leave it till the next post in the series. But the upshot of it is that I was able to write the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert-at == [
</span><span class='line'>  ~1
</span><span class='line'>  ~0 ~2 take
</span><span class='line'>  ~0 ~2 1 + drop
</span><span class='line'>  enconcat
</span><span class='line'>] 3 splice-from-stack;</span></code></pre></td></tr></table></div></figure>


<p>Ignoring the surrounding <code>splice-from-stack</code> call, we&rsquo;ve managed to remove all stack related manipulation. The cost, so it seems, is that we introduced something that looks like custom syntax.</p>

<p><a href="http://ncreep.github.io/language_perils/blog/2013-05-24-meta-joy.html">To be continued</a>&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Joy of Joy]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2013-03-18-the-joy-of-joy.html"/>
    <updated>2013-03-18T06:21:00+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/the-joy-of-joy</id>
    <content type="html"><![CDATA[<p><strong>Intro</strong>: <code>[swap  dip  dup  dip  pop]  dip  dup  dip  pop</code><br/>
(sing aloud accompanied by a Jazz trio or even <em>a cappella</em>)</p>

<p>Anyways, this is actual Joy source code, taken from the <a href="http://www.kevinalbrecht.com/code/joy-mirror/j02maf.html">Mathematical foundations of Joy</a> article. No, really, you&rsquo;re not squinting hard enough, there is some actual math there.</p>

<p>Well, this is my first language from the <a href="http://blog.fogus.me/2011/08/14/perlis-languages/">Perlis Languages</a> list.  It&rsquo;s a concatenative language, colloquially known as a stack-based language (not sure what sort of person goes all colloquial about anything concatenative, probably the sort of person that uses the word &ldquo;colloquial&rdquo;). Stack-based languages tend to have very little in the sense of syntax, one may even call them &ldquo;Lisp without the parentheses&rdquo;. So that makes Joy a good candidate to be the first language for this little project; it&rsquo;s rather simple and self-contained.  You can pretty much get all the material you might need to tackle Joy from the (mirror of) the <a href="http://www.kevinalbrecht.com/code/joy-mirror/joy.html">official site</a>. Other than that, as recommended by Fogus, there&rsquo;s the really nice &ldquo;<a href="http://www.codecommit.com/blog/category/cat">The Joy of Concatenative Languages</a>&rdquo; series by <a href="http://www.codecommit.com">Daniel Spiewak</a>; although his language of choice is Cat, it still is, as usual for Daniel&rsquo;s writings, a very instructive and fun read.</p>

<p>Let&rsquo;s take a quick tour of Joy, though for a proper introduction you should consult the <a href="http://www.kevinalbrecht.com/code/joy-mirror/j01tut.html">official one</a>.</p>

<!-- more -->


<p>To the eyes of a conventional programmer, the first thing that stands out in a stack-based language is the Reverse Polish notation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>3 4 + 5 *</span></code></pre></td></tr></table></div></figure>


<p>(Note that to actually evaluate the snippet in the Joy interpreter, you&rsquo;ll need to put a period at the end, as in <code>3 4 + 5 * .</code>, but I&rsquo;ll be omitting it here).</p>

<p>The above happens to be 35. And that obviously screams at you with the horrid unnaturalness of the out-of-order operators. Of course, the average programmer, being to some extent a form of a humanoid, expects this to be written infix as in:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>3 + 4 * 5</span></code></pre></td></tr></table></div></figure>


<p>Wait, that&rsquo;s actually 23. Of course I meant to write:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(3 + 4) * 5</span></code></pre></td></tr></table></div></figure>


<p>Now it&rsquo;s all natural and pleasing to the eye. And that&rsquo;s the last time in the Joy series that you&rsquo;ll be seeing anything written infix, get used to it, sorry&hellip;</p>

<p>Actually, there&rsquo;s a whole thing based around RPN having no precedence issues; it allows one to compose programs (functions) by just <em>concatenating</em> their sources &ndash; no need to worry about any missing parentheses. And that&rsquo;s why you call them <em>concatenative</em> languages; the stack is actually an optional implementation detail.<br/>
Having crossed the RPN chasm, we can continue to some Joy basics.</p>

<p>We&rsquo;ve already seen number literals and arithmetic operators. We also have the usual boolean values <code>true</code> and <code>false</code>; string literals are written in double quotes, and characters are prefixed with a single quote. So the following snippet yields <code>true</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"abcd" 1 at 'b equal</span></code></pre></td></tr></table></div></figure>


<p>Now I&rsquo;ll pretend that you know practically nothing about stacks and explain this snippet step by step. Having done that, I&rsquo;ll assume that by some miracle, you are now fluent in everything stack, and I wouldn&rsquo;t be bothered to give any more accounts of the source at such level of detail. Ready? Here we go:<br/>
The first word pushes <code>"abcd"</code> onto the stack; the second <code>1</code>. <code>at</code> looks at the last two things on the stack and treats the top one as a (zero based) index and the one below it as a string (or a list, we&rsquo;ll get to those in a bit). It then pops them off and leaves on top the character at the indexed position, in our case <code>'b</code>. Next we push another <code>'b</code> onto the top of the stack and test the equality of the top two items on the stack with <code>equal</code>, popping them off and pushing the result (<code>true</code>) onto the top.</p>

<p>Feeling fluent now? Great, moving on&hellip;</p>

<p>Next we have list literals, written in square brackets, so this yields 3:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1 2 3 4 5] 2 at</span></code></pre></td></tr></table></div></figure>


<p>Lists are heterogeneous and can contain anything, so this <code>[1 'c 2 "abc" [1 2 3] 5]</code> is a valid list.</p>

<p>Set literals can be written in curly brackets, as in <code>{1 2 3}</code>, but they can only contain &ldquo;small integers&rdquo;, so I didn&rsquo;t really have any use for them further down the road (too bad you can&rsquo;t plug in other implementations into this syntax, oh well&hellip;).</p>

<p>There is also a whole array of stack manipulation functions, such as swapping and duplicating items on the stack. So the following yields the square of 4:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>4 dup *  # =&gt; 16</span></code></pre></td></tr></table></div></figure>


<p>(The hash sign designates a comment)</p>

<p><strong>Interlude</strong>: <code>[[dup  dip  pop]  dip]  dip  swap  dip  dup  dip  pop</code></p>

<p>Now come the interesting bits &ndash; the lists introduced above are not plain lists, they are quoted programs (think Lisp lists). This means that the list <code>[4 dup *]</code> is actually a value representing the program above; it can be passed around and evaluated at will. Evaluation is accomplished via <em>combinators</em>. These take quoted programs as input and use them to calculate new values.<br/>
The simplest combinator is <code>i</code>; it just evaluates (unquotes) the quoted program at the top of the stack, like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[4 dup *] i # =&gt; 16</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at a slightly more interesting example. The combinator <code>map</code> takes a quoted program and applies it to the elements of a list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1 2 3 4] [dup *] map # =&gt; [1 4 9 16]</span></code></pre></td></tr></table></div></figure>


<p>The above is one of the most common use cases for higher order functions, so we got that topic covered.</p>

<p>By now, you might&rsquo;ve noticed the conspicuous lack of control structures, guess what, these are also implemented with combinators. The standard <code>if then else</code> form looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1500 [1000 &gt;]  [2 /]  [3 *]  ifte  # =&gt; 750</span></code></pre></td></tr></table></div></figure>


<p>The first list is the condition, which is checked against the top of the stack (in this case 1500). If the condition is met, we apply the second quote to the top of the stack, otherwise the third.<br/>
It takes a little time to get used to this sort of syntax, but after you get it, there&rsquo;s a whole world of flexibility here&hellip;</p>

<p>The last type of combinators we&rsquo;ll look at are recursive combinators. These allow one to create recursive functions using anonymous recursion. The most basic recursive combinator is <code>linrec</code>, which performs linear recursion. The textbook example for linear recursion is the factorial, implementing it with <code>linrec</code> we get</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[null]  [succ]  [dup pred]  [*]  linrec</span></code></pre></td></tr></table></div></figure>


<p>The first quote is the <code>if</code> part, it checks for the base case (here, whether the current argument is 0). The second quote is the <code>then</code> part, which is executed when we reach the base case (here, when we reach 0, we take its successor, 1, and leave it on the stack). The last two quotes are the <code>else1</code> and <code>else2</code> parts. The first is executed before we take the recursive step; in here we duplicate the argument and take the predecessor of the copy. The second quote is executed after the recursion step, in this case we multiply the top two items on the stack. To sum up, we are recursively filling up the stack with the numbers from the given argument down to 1, then, when we back up, we are multiplying them in pairs leaving the result on top all the time, until we reach the original value. The last multiplication step gives us the value of the factorial at the top of the stack.</p>

<p>I found combinators to be my biggest stumbling block on the path to readability &ndash; when looking at a new combinator, you really haven&rsquo;t a chance of figuring out its purpose unless its name is very obvious or you have its documentation at hand. Take this for example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1]  [*]  primrec</span></code></pre></td></tr></table></div></figure>


<p>Can you guess what that function does? It happens to be the very same factorial function from before, implemented with a specialized version of <code>linrec</code>; it wasn&rsquo;t that obvious to me&hellip;<br/>
As you know, with great flexibility come great code obfuscation powers. But also, great DSL powers, and I really like DSLs, so overall, I&rsquo;m sure the whole combinators thing works out fine.</p>

<p>There are plenty more useful functions and combinators; you can see the whole standard library <a href="http://www.kevinalbrecht.com/code/joy-mirror/html-manual.html">here</a>.</p>

<p>The last bit of syntax I left out are definitions; you can actually give names to stuff in Joy. So if we wanted to name our square and factorial functions, we could do it like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DEFINE 
</span><span class='line'>   square == dup *;
</span><span class='line'>   factorial == [1]  [*]  primrec.</span></code></pre></td></tr></table></div></figure>


<p>And use it like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>4 square # =&gt; 16
</span><span class='line'>5 factorial # =&gt; 120</span></code></pre></td></tr></table></div></figure>


<p>There are also some modularization/information hiding facilities built in, but I won&rsquo;t be using them here, so moving right along.</p>

<p>This sums up my not so brief but definitely incomplete introduction to Joy. The most glaring thing I glossed over is the mathematical foundations of Joy. It so happens that Joy is a function-level programming language, in the sense that there are no values in the language, just functions. No, <code>42</code> is not a value, <code>42</code> is a function that takes a stack and returns a new stack with the value <code>42</code> on top. So without noticing it, all along we&rsquo;ve been composing functions and not just that &ndash; we&rsquo;ve been using point-free style while at it.<br/>
Although I didn&rsquo;t delve deep into the maths myself, its presence definitely makes me feel better. I like it when a language is well thought through; such elegance can only come from math.</p>

<p>All together now:<br/>
<strong>Outro</strong>: <code>[dup dip pop]  dip  dup  dip  pop</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introduction]]></title>
    <link href="http://ncreep.github.io/language_perils/blog/2013-03-18-introduction.html"/>
    <updated>2013-03-18T04:45:00+02:00</updated>
    <id>http://ncreep.github.io/language_perils/blog/introduction</id>
    <content type="html"><![CDATA[<p>I like programming languages, and I just couldn&rsquo;t find a proper excuse to learn them. So I decided to go on and learn them without an excuse.</p>

<p>My first attempt at doing so was via the amazing book by <a href="http://rapidred.com/">Bruce Tate</a>, &ldquo;<a href="http://www.amazon.com/gp/product/193435659X/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=193435659X&amp;linkCode=as2&amp;tag=languperil-20">Seven Languages in Seven Weeks</a>&rdquo; (great read, highly recommended).</p>

<p>After sparking my initial interest in learning programming languages for fun (and ruining my ability to calmly write plain old Java), that book left me with an itch for more. The itch kept on spreading when I came across a blog post &ldquo;<a href="http://blog.fogus.me/2011/08/14/perlis-languages/">Perlis Languages</a>&rdquo; by the brilliant <a href="http://www.fogus.me/">Fogus</a>, go on and read it.</p>

<p>As I personally almost never go on and read stuff pointed to in posts, I&rsquo;ll give a quick recap of that post here.</p>

<p>It starts off with a quote by Alan Perlis:</p>

<blockquote><p>A language that doesn&rsquo;t affect the way you think about programming is not worth knowing.</p></blockquote>

<p>Next, Fogus goes on to explain how one can and should expand one&rsquo;s views on software development, namely, by learning &ldquo;Perlis Languages&rdquo;:</p>

<blockquote><p>A Perlis Language is a programming language that I believe will shake one&rsquo;s views on software development to the core.</p></blockquote>

<!-- more -->


<p>This is followed by a list of (mostly esoteric) programming languages, with their short descriptions, code samples and links to further information. (You really should read the full post, though.)</p>

<p>And I got this idea – to start learning the languages from that list and document the process here.</p>

<p>So how is it going to work? Well, I&rsquo;ll randomly select a language from the list and go on and learn it. To show off my newly acquired knowledge, I&rsquo;ll devise a small project or two to implement using the language. The project (or two) will probably be something for a couple of weeks work, e.g., the sort of projects you may get as homework assignments in CS classes. As the process goes on, I&rsquo;ll be posting my impressions here.</p>

<p>What&rsquo;s in it for you, you&rsquo;ll ask? First off, you&rsquo;ll get a glimpse into the twisted mind of a budding polyglot &ndash; who knows what sort of gray matter you may find there? Other than that, I hope this whole thing might have some educational value, either for people like me who just enjoy learning new languages, or, maybe, for the occasional language designer, who might find a user&rsquo;s point of view in some way conducive to his or her PL activities.</p>

<p>And now for a short disclaimer:</p>

<p>This is going to be an ongoing side project of mine, so I can&rsquo;t really guarantee my rate of progress; hopefully I&rsquo;ll have enough time and will power to keep on going at a relatively constant rate.</p>

<p>The language list is not fixed in stone; I might omit some languages from the original list and maybe add some other languages. It all will be guided by what is most interesting to me at the moment, though don&rsquo;t expect to see your regular Java.next language here&hellip;</p>

<p>In any case, I&rsquo;m not pretending to be any sort of expert in any of the languages I&rsquo;m about to learn (duh…). Feedback and constructive criticism are always more than welcome.</p>

<p>Next stop, <a href="http://ncreep.github.io/language_perils/blog/2013-03-18-the-joy-of-joy.html">Joy</a>.</p>
]]></content>
  </entry>
  
</feed>
